Private Sub carregar_edi_Click()

    'on error GoTo tratar_erro
    
    If (IsNull(Me.data_edi)) Then
        aviso = "INFORME UMA DATA PARA CARREGAR O EDI DO LOGIX!!"
        Call rot_aviso
        Me.data_edi.SetFocus
        Exit Sub
    End If
    Call inibir_legendas
    Call inibir_funcoes
    Call exibir_barra_proc
    Me.data_edi.SetFocus
    Me.carregar_edi.Enabled = False
    Me.sair.Enabled = False
    DoCmd.Hourglass True
    exibbar = SysCmd(acSysCmdSetStatus, "  ABRINDO BANCO DE DADOS - LOGIX ...")
    cam_arqs = Trim(CurrentDbDir)
    Set connOnLine = New ADODB.Connection
    connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
    Set tra = New ADODB.Recordset
    Set edi = New ADODB.Recordset
    Set lgr = New ADODB.Recordset
    Set lei = New ADODB.Recordset
    Set div = New ADODB.Recordset
    Set nre = New ADODB.Recordset
    Set cpd = New ADODB.Recordset
    Set emb = New ADODB.Recordset
    Set gre = New ADODB.Recordset
    Set gdi = New ADODB.Recordset
    Set itg = New ADODB.Recordset
    
    GoSub deletar_grupo_capacidade

    sql = "select *        " _
        & "  from tran_arg " _
        & " where cod_empresa         = '" & selemp & "' " _
        & "   and trim(num_programa)  = 'EDIANAPRZ'  " _
        & "   and data_proc           = '" & Format(Me.data_edi, "dd/mm/yyyy") & "' " _
       
    If (tra.State) <> adStateClosed Then tra.Close
            
    telacorr = DoEvents
    tra.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
    telacorr = DoEvents
    
    If Not tra.EOF Then
       aviso = "O EDI DE " & Format(Me.data_edi, "dd/mm/yyyy") & " " _
             & "JÁ ESTÁ EM PROCESSAMENTO PELO USUÁRIO: " & Trim(tra.Fields("login_usuario")) & ", " _
             & "AGUARDE ALGUNS INSTANTES E TENTE ABRIR NOVAMENTE ESTE DIA PARA ANALISAR OS PRAZOS!!"
       Call rot_aviso
       GoSub libera_saida
       Exit Sub
    Else
       sql = "select *        " _
           & "  from tran_arg " _
           & " where cod_empresa         = '" & selemp & "' " _
           & "   and trim(num_programa)  = 'EDIANAPRZ'  " _
           & "   and trim(login_usuario) = '" & Left(nom_usu, 8) & "' "
          
       If (tra.State) <> adStateClosed Then tra.Close
            
       telacorr = DoEvents
       tra.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
       telacorr = DoEvents
       If Not tra.EOF Then
          aviso = "EXISTE UM PROCESSAMENTO EM ABERTO EM SEU USUÁRIO: '" & Trim(tra.Fields("login_usuario")) & "', " _
                & "VOCÊ NÃO CONSEGUIRÁ FAZER QUALQUER PROCESSAMENTO NESTA TELA. CASO ALGUEM ESTEJA UTILIZANDO SEU USUÁRIO, " _
                & "AGUARDE ATÉ QUE O PROCESSAMENTO SEJA CONCLUÍDO, CASO CONTRARIO, SOLICITE AO TI ELIMINAR OS DADOS DE " _
                & "PROCESSAMENTO DA TABELA 'TRAN_ARG' REFERENTE O USUÁRIO: '" & Trim(tra.Fields("login_usuario")) & "' " _
                & "QUE ESTÁ APARECENDO NO CABEÇALHO DESTA TELA!!"
          Call rot_aviso
          GoSub libera_saida
          Exit Sub
       Else
          tra.AddNew
          tra.Fields("cod_empresa") = selemp
          tra.Fields("num_programa") = "EDIANAPRZ"
          tra.Fields("login_usuario") = Left(nom_usu, 8)
          tra.Fields("data_proc") = Format(Me.data_edi, "dd/mm/yyyy")
          tra.Fields("hora_proc") = Format(Time, "dd/mm/yyyy")
          tra.Fields("num_arg") = 0
          tra.Fields("indice_arg") = 0
          tra.Fields("arg_data") = Format(Date, "dd/mm/yyyy")
          tra.Update
       End If
    End If
' aquicarga
    GoSub carregar_dados
    Call inibir_barra_proc
    GoSub monta_cabec
    o_que_sera_exibido = "T"
    Call ler_dados_view
    Me.carregar_edi.Enabled = True
    Me.sair.Enabled = True
    Me.data_edi.SetFocus
    
    GoSub deletar_tran_arg
    GoSub libera_saida
       
    exibbar = SysCmd(acSysCmdSetStatus, "  PROCESSAMENTO CONCLUÍDO...")
    aviso = "PROCESSAMENTO CONCLUÍDO!!"
    Call rot_aviso
    exibbar = SysCmd(acSysCmdSetStatus, " ")
fim:
    DoCmd.Hourglass False
    Call inibir_barra_proc
    Me.carregar_edi.Enabled = True
    Me.sair.Enabled = True
    Me.data_edi.SetFocus
Exit Sub

tratar_erro:
    aviso = Err.Number & " - " & Err.Description
    Call rot_aviso
    Resume fim

monta_cabec:
    With ListView1
         .GridLines = True
         .View = lvwReport
         .HoverSelection = False
         .HideSelection = False
         .FullRowSelect = True
         .HotTracking = True
         .ColumnHeaders.Add(Text:="REGISTRO", Width:=0, Alignment:=fmAlignmentLeft).Tag = "registro"
         .ColumnHeaders.Add(Text:="REG_LOG", Width:=0, Alignment:=fmAlignmentLeft).Tag = "reg_logico"
         .ColumnHeaders.Add(Text:="ENTRADA", Width:=980, Alignment:=fmAlignmentLeft).Tag = "carregado"
         .ColumnHeaders.Add(Text:="PEDIDO", Width:=850, Alignment:=fmAlignmentLeft).Tag = "pedido"
         .ColumnHeaders.Add(Text:="SEQ", Width:=600, Alignment:=fmAlignmentright).Tag = "sequencia"
         .ColumnHeaders.Add(Text:="OBS", Width:=600, Alignment:=fmAlignmentright).Tag = "tem_obs"
         .ColumnHeaders.Add(Text:="DIV", Width:=600, Alignment:=fmAlignmentright).Tag = "tem_diverg"
         .ColumnHeaders.Add(Text:="AMOS", Width:=770, Alignment:=fmAlignmentright).Tag = "amostra"
         .ColumnHeaders.Add(Text:="ITEM CLIENTE", Width:=1650, Alignment:=fmAlignmentLeft).Tag = "cod_item_cliente"
         .ColumnHeaders.Add(Text:="ITEM", Width:=1650, Alignment:=fmAlignmentLeft).Tag = "cod_item"
         .ColumnHeaders.Add(Text:="TAM", Width:=600, Alignment:=fmAlignmentLeft).Tag = "tamanho_etapa"
         .ColumnHeaders.Add(Text:="DESCRIÇÃO", Width:=2100, Alignment:=fmAlignmentLeft).Tag = "den_item_reduz"
         .ColumnHeaders.Add(Text:="ABERTURA", Width:=1460, Alignment:=fmAlignmentLeft).Tag = "dat_abertura"
         .ColumnHeaders.Add(Text:="SHIP DATE CLI", Width:=1460, Alignment:=fmAlignmentLeft).Tag = "ship_date_cli"
         .ColumnHeaders.Add(Text:="SHIP SUGERIDO", Width:=1500, Alignment:=fmAlignmentLeft).Tag = "ship_date_sug"
         .ColumnHeaders.Add(Text:="QTDE", Width:=800, Alignment:=fmAlignmentCenter).Tag = "qtd_aceita_cli"
         .ColumnHeaders.Add(Text:="SIT.GER.EDI", Width:=1200, Alignment:=fmAlignmentCenter).Tag = "sit_gerada_edi"
         .ColumnHeaders.Add(Text:="A", Width:=600, Alignment:=fmAlignmentCenter).Tag = "tipo_pedido"
         .ColumnHeaders.Add(Text:="B", Width:=600, Alignment:=fmAlignmentCenter).Tag = "qtd_dias_pad_tp_ped"
         .ColumnHeaders.Add(Text:="C", Width:=600, Alignment:=fmAlignmentCenter).Tag = "qtd_dias_ute_tp_ped"
         .ColumnHeaders.Add(Text:="D", Width:=600, Alignment:=fmAlignmentCenter).Tag = "qtd_dias_neces_produ"
         .ColumnHeaders.Add(Text:="INI.PROD.PAD", Width:=1430, Alignment:=fmAlignmentLeft).Tag = "dat_inicio_producao"
         .ColumnHeaders.Add(Text:="FIM.PROD.PAD", Width:=1430, Alignment:=fmAlignmentLeft).Tag = "dat_fim_producao"
         .ColumnHeaders.Add(Text:="INI.PROD.ESP", Width:=1430, Alignment:=fmAlignmentLeft).Tag = "dat_inicio_prd_recal"
         .ColumnHeaders.Add(Text:="FIM.PROD.ESP", Width:=1430, Alignment:=fmAlignmentLeft).Tag = "dat_fim_prod_recal"
         .ColumnHeaders.Add(Text:="CLIENTE", Width:=2100, Alignment:=fmAlignmentLeft).Tag = "cliente_raz_reduz"
    End With
Return

carregar_dados:

   sql = "set isolation to dirty read "
   If (edi.State) <> adStateClosed Then edi.Close
       
   telacorr = DoEvents
   edi.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents
  
   sql = "select count(*) qtd_reg_aproc                                          " _
       & "  from prog_efetivada_547                                              " _
       & "     where cod_empresa = '" & selemp & "'                            " _
       & "       and dat_proces  = '" & Format(Me.data_edi, "dd/mm/yyyy") & "' "
  
   telacorr = DoEvents
   edi.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents

   
   qtd_reg_proc = edi.Fields("qtd_reg_aproc")
   
   If qtd_reg_proc > 0 Then
      Me.ProgressBar1.Min = 0
      Me.ProgressBar1.Value = 0
      Me.ProgressBar1.Max = qtd_reg_proc
   End If
   
   sql = "set isolation to dirty read "
   If (edi.State) <> adStateClosed Then edi.Close
      
   telacorr = DoEvents
   edi.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents
   
   
   sql = " select a.num_pedido pedido,      " _
       & "        j.num_sequencia num_seq, " _
       & "        f.cod_item_cliente, " _
       & "        a.cod_item, " _
       & "        k.cod_etapa tamanho, " _
       & "        c.den_item_reduz, " _
       & "        a.dat_proces carregado, " _
       & "        j.prz_entrega abertura, " _
       & "        g.ship_date, " _
       & "        a.qtd_aceita, " _
       & "        a.sit_programa, " _
       & "        case " _
       & "        when h.tipo_item Is Not Null " _
       & "        then trim(h.tipo_item)||'-'||cast(h.qtd_dias as decimal(10,0))||' DIAS' " _
       & "        else b.num_pedido_cli [1,2] " _
       & "        end tipo_pedido, " _
       & "        case " _
       & "        when h.tipo_item Is Not Null " _
       & "        then cast(h.qtd_dias as decimal(10,0)) " _
       & "        else cast(i.parametro_numerico as decimal(10,0)) " _
       & "        end dias_padrao_tipo, " _
       & "        a.rowid reg_log, "
  
  sql0 = "        case " _
       & "        when e.num_pedido Is Not Null " _
       & "        then 'SIM' " _
       & "        else '   ' " _
       & "        end amostra, " _
       & "        d.nom_reduzido cliente " _
       & "   from prog_efetivada_547 a " _
       & "   join pedidos b " _
       & "     on (a.cod_empresa = b.cod_empresa) " _
       & "    and (a.num_pedido  = b.num_pedido) " _
       & "   join ped_itens j " _
       & "     on (a.cod_empresa   = j.cod_empresa) " _
       & "    and (a.num_pedido    = j.num_pedido) " _
       & "    and (a.prz_entrega   = j.prz_entrega) " _
       & "    and (a.cod_item      = j.cod_item) "
       
  sql1 = "   left join ped_itens_ethos g                 " _
       & "          on (a.cod_empresa   = g.cod_empresa) " _
       & "         and (a.num_pedido    = g.num_pedido) " _
       & "         and (j.num_sequencia = g.num_sequencia) " _
       & "   left join item c " _
       & "          on (a.cod_empresa = c.cod_empresa) " _
       & "         and (a.cod_item    = c.cod_item) " _
       & "   left join ped_itens_texto e " _
       & "          on (a.cod_empresa = e.cod_empresa) " _
       & "         and (a.num_pedido  = e.num_pedido) " _
       & "         and (e.den_texto_1 like '%AMOSTRA%') " _
       & "   left join clientes d " _
       & "          on (b.cod_cliente          = d.cod_cliente) " _
       & "   left join cliente_item f " _
       & "          on (a.cod_empresa          = f.cod_empresa) " _
       & "         and (b.cod_cliente          = f.cod_cliente_matriz) " _
       & "         and (a.cod_item             = f.cod_item) "

  sql2 = "   left join item_kanban_547 h " _
       & "          on (a.cod_empresa          = h.cod_empresa) " _
       & "         and (a.cod_item             = h.cod_item) " _
       & "         and (f.cod_item_cliente     = h.cod_item_cliente) " _
       & "         and (h.dat_inicio          <= today) " _
       & "         and (h.dat_termino         >= today) " _
       & "   left join item_man k                       " _
       & "          on (a.cod_empresa          = k.cod_empresa) " _
       & "         and (a.cod_item             = k.cod_item)  " _
       & "   left join min_par_modulo i " _
       & "          on (a.cod_empresa          = i.empresa) " _
       & "         and (i.parametro         like '%'||b.num_pedido_cli[1,2]||'%') " _
       & "     where a.cod_empresa = '" & selemp & "'                            " _
       & "       and a.dat_proces  = '" & Format(Me.data_edi, "dd/mm/yyyy") & "' " _
       & "     order by 1,2 "

  
  sql = sql & sql0 & sql1 & sql2

  
  telacorr = DoEvents
  edi.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents

  If edi.EOF Then
     aviso = "NÃO EXISTEM DADOS NO EDI DO LOGIX PARA A DATA SELECIONADA ACIMA!!"
     Call rot_aviso
     GoSub deletar_tran_arg
     GoSub libera_saida
     Me.data_edi.SetFocus
     Exit Sub
  End If
  
  Do While Not edi.EOF
     sql = "delete from ethos_edi_pedidos " _
         & " where cod_empresa    = '" & selemp & "'              " _
         & "   and num_pedido     = " & edi.Fields("pedido") & "  " _
         & "   and num_seq_pedido = " & edi.Fields("num_seq") & " " _
         & "   and desconsiderado = 'N'                           " _
         & "   and registro_em_uso is null                        " _
     
     If (lgr.State) <> adStateClosed Then lgr.Close
     
     telacorr = DoEvents
     lgr.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
     telacorr = DoEvents
     edi.MoveNext
  Loop
  
  edi.MoveFirst
  
  Do While Not edi.EOF
     exibbar = SysCmd(acSysCmdSetStatus, "  LENDO E TRATANDO EDI DO LOGIX, PEDIDO: " & edi.Fields("pedido") & ", ITEM: " & edi.Fields("num_seq"))
     
     sql = "select *                                              " _
         & "  from ethos_edi_pedidos                              " _
         & " where cod_empresa     = '" & selemp & "'              " _
         & "   and num_pedido      = " & edi.Fields("pedido") & "  " _
         & "   and num_seq_pedido  = " & edi.Fields("num_seq") & " " _
         & "   and desconsiderado  = 'N'                           " _
         & "   and registro_em_uso is null                        " _
  
     If (lgr.State) <> adStateClosed Then lgr.Close
     
     telacorr = DoEvents
     lgr.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
     telacorr = DoEvents
     param_tempos = "TODOS"
         
     If lgr.EOF Then
        lgr.AddNew
        GoSub gravar_novo_edi
        lgr.Fields("num_registro") = 0
        lgr.Update
        GoSub gravar_num_registro
     End If
     
     edi.MoveNext
     
     Me.ProgressBar1.Value = Me.ProgressBar1.Value + 1
     Me.perc_pro = (ProgressBar1.Value * 100 / ProgressBar1.Max)
     
     If edi.EOF Then Exit Do
  Loop
    
Return

gravar_novo_edi:
   dt_entr_e_feriado = "N"
   ship_date_feriado = "N"
   ship_menor_entrega = "N"

   data_base = Format(edi.Fields("abertura"), "dd/mm/yyyy")
   Call validar_data_util
   If o_dia_e_util = "N" Then dt_entr_e_feriado = "S"
   
   If (IsNull(edi.Fields("ship_date"))) Then
      data_base = Format(edi.Fields("abertura"), "dd/mm/yyyy")
      sem_ship = "S"
   Else
      data_base = Format(edi.Fields("ship_date"), "dd/mm/yyyy")
      sem_ship = "N"
   End If
   
   If sem_ship = "N" Then
      If Format(edi.Fields("ship_date"), "yyyy/mm/dd") < Format(edi.Fields("abertura"), "yyyy/mm/dd") Then
         data_base = Format(edi.Fields("abertura"), "dd/mm/yyyy")
         ship_menor_entrega = "S"
      Else
         ship_menor_entrega = "N"
      End If
   End If
   
   Call validar_data_util
   If o_dia_e_util = "N" Then ship_date_feriado = "S"
   
   GoSub deletar_divergencias
   data_carga_edi = Format(edi.Fields("carregado"), "dd/mm/yyyy")
   pai = Trim(edi.Fields("cod_item"))
   pai_princ = Trim(edi.Fields("cod_item"))
   vdat_entrega_princ = Format(data_base, "dd/mm/yyyy")
   vnum_pedido = edi.Fields("pedido")
   vseq_pedido = edi.Fields("num_seq")
   vnum_ordem = 0
   param_tempos = "TODOS"
   param_tmp_seq = 995
   lgr.Fields("cod_empresa") = selemp
   lgr.Fields("carregado") = "EDI"
   lgr.Fields("num_pedido") = edi.Fields("pedido")
   lgr.Fields("num_seq_pedido") = edi.Fields("num_seq")
   lgr.Fields("cod_item_cliente") = Trim(edi.Fields("cod_item_cliente"))
   lgr.Fields("cod_item") = Trim(edi.Fields("cod_item"))
   lgr.Fields("tamanho_etapa") = Trim(edi.Fields("tamanho"))
   lgr.Fields("den_item_reduz") = Trim(edi.Fields("den_item_reduz"))
   lgr.Fields("dat_abertura") = Format(edi.Fields("abertura"), "dd/mm/yyyy")
   lgr.Fields("dat_carga_edi") = Format(edi.Fields("carregado"), "dd/mm/yyyy")
   
   If (IsNull(edi.Fields("tipo_pedido"))) Then
      lgr.Fields("tipo_pedido") = "   "
   Else
     lgr.Fields("tipo_pedido") = edi.Fields("tipo_pedido")
   End If
   
   If (IsNull(edi.Fields("dias_padrao_tipo"))) Then
       lgr.Fields("qtd_dias_pad_tp_ped") = 0
   Else
       lgr.Fields("qtd_dias_pad_tp_ped") = edi.Fields("dias_padrao_tipo")
   End If
   
   data_inicio_edi = Format(edi.Fields("carregado"), "dd/mm/yyyy")
   data_ship = Format(data_base, "dd/mm/yyyy")
   Call achar_dias_uteis
   
   lgr.Fields("qtd_dias_ute_tp_ped") = qtde_dias_uteis
   lgr.Fields("prazos_confirmados") = "S"
   lgr.Fields("tem_diverg") = "N"
      
   If dias_neces_prod > 0 Then
      lgr.Fields("qtd_dias_neces_produ") = dias_neces_prod
      lgr.Fields("dat_inicio_producao") = data_calc_ini_prd
      lgr.Fields("dat_fim_producao") = data_calc_fim_prd
   Else
      lgr.Fields("qtd_dias_neces_produ") = dias_neces_prod
   End If
   
   lgr.Fields("param_tmp_operac") = param_tempos
   lgr.Fields("tem_obs") = "N"
   lgr.Fields("registro_em_uso") = Me.cp_nulo
   lgr.Fields("alterado") = "N"
   lgr.Fields("amostra") = edi.Fields("amostra")
   lgr.Fields("dat_fim_prod_recal") = Me.cp_nulo
   lgr.Fields("dat_inicio_prd_recal") = Me.cp_nulo
   lgr.Fields("desconsiderado") = "N"
   If (IsNull(lgr.Fields("cliente_raz_reduz"))) Then
      lgr.Fields("cliente_raz_reduz") = "NÃO ENCONTRADO"
   Else
      lgr.Fields("cliente_raz_reduz") = Trim(edi.Fields("cliente"))
   End If
   
   
   'tratar divergências
   
   
   If ship_menor_entrega = "S" Then
      txt_diverg = "-SHIP DATE MENOR QUE A ENTREGA, CONSIDERADO A DATA DE ENTREGA.        "
      GoSub gerar_divergencias
      lgr.Fields("prazos_confirmados") = "N"
      lgr.Fields("tem_diverg") = "S"
   End If
   
   
   Me.data_cp_1 = Format(data_base, "yyyy/mm/dd")
   Me.data_cp_2 = Format(data_calc_fim_prd, "yyyy/mm/dd")
   
   If Me.data_cp_2 > Me.data_cp_1 And Left(Trim(edi.Fields("tipo_pedido")), 2) <> "KA" Then
      txt_diverg = "-PRAZO MÍNIMO DE PRODUÇÃO MAIOR QUE O SHIP DATE DESEJADO PELO CLIENTE."
      GoSub gerar_divergencias
      lgr.Fields("prazos_confirmados") = "N"
      lgr.Fields("tem_diverg") = "S"
   End If

   Me.data_cp_1 = Format(Me.data_edi, "yyyy/mm/dd")
   Me.data_cp_2 = Format(data_calc_ini_prd, "yyyy/mm/dd")


   
   'tratamento item em duplicidade pelo ship date
   
   If Not (IsNull(Format(data_base, "dd/mm/yyyy"))) Then
      sql = "set isolation to dirty read "
      
      If (cpd.State) <> adStateClosed Then cpd.Close
      telacorr = DoEvents
      cpd.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
      telacorr = DoEvents
   
      sql = "select         x3.cod_item_cliente, " _
          & "               x1.ship_date,        " _
          & "               x0.num_pedido,       " _
          & "               x0.num_sequencia,    " _
          & "               x0.prz_entrega,      " _
          & "              (x0.qtd_pecas_solic - x0.qtd_pecas_atend - x0.qtd_pecas_cancel) saldo_pc " _
          & "  from ped_itens             x0     " _
          & "  left join ped_itens_ethos  x1     " _
          & "    on (x0.cod_empresa   = x1.cod_empresa)   " _
          & "   and (x0.num_pedido    = x1.num_pedido)    " _
          & "   and (x0.num_sequencia = x1.num_sequencia) " _
          & "  left join pedidos          x2              " _
          & "    on (x0.cod_empresa   = x2.cod_empresa)   " _
          & "   and (x0.num_pedido    = x2.num_pedido)    " _
          & "  left join cliente_item     x3              " _
          & "    on (x0.cod_empresa   = x3.cod_empresa)   " _
          & "   and (x2.cod_cliente   = x3.cod_cliente_matriz) " _
          & "   and (x0.cod_item      = x3.cod_item)           " _
          & " where x0.cod_empresa       = '" & selemp & "' " _
          & "   and x1.ship_date         = '" & Format(data_base, "dd/mm/yyyy") & "' " _
          & "   and (x0.qtd_pecas_solic - x0.qtd_pecas_atend - x0.qtd_pecas_cancel) > 0 " _
          & "   and (x3.cod_item_cliente = '" & Trim(edi.Fields("cod_item_cliente")) & "' " _
          & "    or  x3.cod_item         = '" & Trim(edi.Fields("cod_item")) & "') "
      
      telacorr = DoEvents
      cpd.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
      telacorr = DoEvents
      
      Do While Not cpd.EOF
         
         If cpd.Fields("num_pedido") <> edi.Fields("pedido") Then
            txt_diverg = "-O ITEM CLIENTE DESTE PED/SEQ DO SHIP DATE: " & Format(data_base, "dd/mm/yyyy") & " FOI ENCONTRADO"
            GoSub gerar_divergencias
            txt_diverg = "NO PED: (" & cpd.Fields("num_pedido") & "), SEQ: [" & cpd.Fields("num_sequencia") & "] DE ABERTURA: " & cpd.Fields("prz_entrega") & " C/SALDO DE: " & Format(cpd.Fields("saldo_pc"), "##,###0.000")
            GoSub gerar_divergencias
            lgr.Fields("prazos_confirmados") = "N"
            lgr.Fields("tem_diverg") = "S"
         End If
         
         If cpd.Fields("num_pedido") = edi.Fields("pedido") And cpd.Fields("num_sequencia") <> edi.Fields("num_seq") Then
            txt_diverg = "-O ITEM CLIENTE DESTE PED/SEQ DO SHIP DATE: " & Format(data_base, "dd/mm/yyyy") & " FOI ENCONTRADO"
            GoSub gerar_divergencias
            txt_diverg = "NO PED: (" & cpd.Fields("num_pedido") & "), SEQ: [" & cpd.Fields("num_sequencia") & "] DE ABERTURA: " & cpd.Fields("prz_entrega") & " C/SALDO DE: " & Format(cpd.Fields("saldo_pc"), "##,###0.000")
            GoSub gerar_divergencias
            lgr.Fields("prazos_confirmados") = "N"
            lgr.Fields("tem_diverg") = "S"
         End If
         cpd.MoveNext
      Loop
   End If
   
   
   ' tratamento da divergencia qtde produzida dia do item
   sql = "set isolation to dirty read "
   
   If (cpd.State) <> adStateClosed Then cpd.Close
   telacorr = DoEvents
   cpd.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents

   sql = " select cast(des_inf_tecnica as decimal(17,3)) qtde_prod_dia  " _
       & "   from info_tecnicas  " _
       & " where cod_empresa      = '" & selemp & "' " _
       & "   and cod_compon       = '" & Trim(edi.Fields("cod_item")) & "' " _
       & "   and cod_pdr_info_tec = 994 " _
       & "   and num_seq          = 1 "
   
   telacorr = DoEvents
   cpd.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents

   If Not cpd.EOF Then
      qtde_capac_prod_nos_dias_uteis = qtde_dias_uteis * cpd.Fields("qtde_prod_dia") ' não utilizada
      If edi.Fields("qtd_aceita") > cpd.Fields("qtde_prod_dia") Then
         txt_diverg = "IMPOSSÍVEL ATENDER PEDIDO DEVIDO CAPACIDADE DIÁRIA DE PRODUÇÃO DO ITEM"
         GoSub gerar_divergencias
         lgr.Fields("prazos_confirmados") = "N"
         lgr.Fields("tem_diverg") = "S"
      End If
   Else
      sql = "set isolation to dirty read "
   
      If (gre.State) <> adStateClosed Then gre.Close
      telacorr = DoEvents
      gre.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
      telacorr = DoEvents
      
      sql = "select cod_empresa,                                           " _
          & "       cod_pdr_info_tec grupo,                                " _
          & "       cod_compon cod_item,                                   " _
          & "       cast(des_inf_tecnica as decimal(17,3)) qtde_dia        " _
          & "  from info_tecnicas                                          " _
          & " where cod_pdr_info_tec >= 980                                " _
          & "   and cod_pdr_info_tec <= 993                                " _
          & "   and num_seq          = 1                                   " _
          & "   and cod_empresa      = '" & selemp & "'                    " _
          & "   and cod_compon       = '" & Trim(edi.Fields("cod_item")) & "' " _

      telacorr = DoEvents
      gre.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
      telacorr = DoEvents
      
      If Not gre.EOF Then
         sql = "select cod_empresa,                                                  " _
             & "       cod_pdr_info_tec grupo,                                       " _
             & "       cod_compon cod_item,                                          " _
             & "       cast(des_inf_tecnica as decimal(17,3)) qtde_dia               " _
             & "  from info_tecnicas                                                 " _
             & " where cod_pdr_info_tec >= 980                                       " _
             & "   and cod_pdr_info_tec <= 993                                       " _
             & "   and cod_empresa      = '" & selemp & "'                           " _
             & "   and num_seq          = 1                                          " _
             & "   and cod_pdr_info_tec = " & gre.Fields("grupo") & "                " _
             & "   and not exists(                                                   " _
             & "select *                                                             " _
             & "  from ethosm_grupo_dia                                              " _
             & " where ethosm_grupo_dia.cod_empresa = info_tecnicas.cod_empresa      " _
             & "   and ethosm_grupo_dia.carga_edi   = '" & Me.data_edi & "'          " _
             & "   and ethosm_grupo_dia.grupo       = info_tecnicas.cod_pdr_info_tec " _
             & "   and ethosm_grupo_dia.cod_item    = info_tecnicas.cod_compon)      "
      
         telacorr = DoEvents
         If (gdi.State) <> adStateClosed Then gdi.Close
         gdi.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
         telacorr = DoEvents
      
         Do While Not gdi.EOF
            valor_vp = gdi.Fields("qtde_dia")
            Call tr_vp
            sql = "insert                   " _
                & "  into ethosm_grupo_dia  " _
                & "values('" _
                & selemp & "', '" _
                & Me.data_edi & "', '" _
                & gdi.Fields("grupo") & "', '" _
                & gdi.Fields("cod_item") & "', '" _
                & valor_vp & "', '" _
                & "0" & "')"
            
            If (nre.State) <> adStateClosed Then nre.Close
   
            telacorr = DoEvents
            nre.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
            telacorr = DoEvents
            
            gdi.MoveNext
            If gdi.EOF Then Exit Do
         Loop
         
         sql = "select *, rowid reg_log   " _
             & "  from ethosm_grupo_dia   " _
             & " where cod_empresa = '" & selemp & "' " _
             & "   and carga_edi   = '" & Me.data_edi & "' " _
             & "   and grupo       = " & gre.Fields("grupo") & " " _
             & "   and cod_item    = '" & Trim(edi.Fields("cod_item")) & "' " _
      
         telacorr = DoEvents
         If (itg.State) <> adStateClosed Then itg.Close
         itg.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
         telacorr = DoEvents
      
         If Not itg.EOF Then
            valor_vp = edi.Fields("qtd_aceita")
            Call tr_vp
            sql = "update ethosm_grupo_dia " _
                & "   set qtde_enc_edi = qtde_enc_edi + " & valor_vp & " " _
                & " where cod_empresa = '" & itg.Fields("cod_empresa") & "' " _
                & "   and rowid       = " & itg.Fields("reg_log")
            If (nre.State) <> adStateClosed Then nre.Close
   
            telacorr = DoEvents
            nre.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
            telacorr = DoEvents
         End If
         
         sql = "select sum(qtde_par_dia) qtde_dia, sum(qtde_enc_edi) qtde_edi  " _
             & "  from ethosm_grupo_dia   " _
             & " where cod_empresa = '" & selemp & "' " _
             & "   and carga_edi   = '" & Me.data_edi & "' " _
             & "   and grupo       = " & gre.Fields("grupo") & " " _
      
         telacorr = DoEvents
         If (itg.State) <> adStateClosed Then itg.Close
         itg.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
         telacorr = DoEvents
        
         If Not itg.EOF Then
            If itg.Fields("qtde_edi") > itg.Fields("qtde_dia") Then
               txt_diverg = "IMPOSSÍVEL ATENDER PEDIDO DEVIDO CAPACIDADE DIÁRIA PRODUÇÃO GRUPO/ITEM"
               GoSub gerar_divergencias
               lgr.Fields("prazos_confirmados") = "N"
               lgr.Fields("tem_diverg") = "S"
            End If
         End If
      End If
   End If
   
   
   ' tratamento da divergencia embalagem
   sql = "set isolation to dirty read "
   
   If (cpd.State) <> adStateClosed Then cpd.Close
   telacorr = DoEvents
   cpd.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents

   sql = "select first 1 * from item_embalagem " _
       & " where cod_empresa      = '" & selemp & "' " _
       & "   and cod_item         = '" & Trim(edi.Fields("cod_item")) & "' " _
    
   telacorr = DoEvents
   cpd.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents
   
   If cpd.EOF Then
      txt_diverg = "EMBALAGEM DO ITEM NÃO CADASTRADA NO LOGIX.                            "
      GoSub gerar_divergencias
      lgr.Fields("prazos_confirmados") = "N"
      lgr.Fields("tem_diverg") = "S"
   End If
   
   
   sql = "set isolation to dirty read "
   
   If (emb.State) <> adStateClosed Then emb.Close
   telacorr = DoEvents
   emb.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents

   sql = "select * from ethosm_ite_emb " _
       & " where cod_empresa      = '" & selemp & "' " _
       & "   and cod_item         = '" & Trim(edi.Fields("cod_item")) & "' " _
       & "   and logix_edi   = 'E' "
    
   telacorr = DoEvents
   emb.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents
   
   If emb.EOF Then
      txt_diverg = "EMBALAGEM DO ITEM NÃO ENVIADA NO EDI.                                 "
      GoSub gerar_divergencias
      lgr.Fields("prazos_confirmados") = "N"
      lgr.Fields("tem_diverg") = "S"
   End If
   
   If Not cpd.EOF And Not emb.EOF Then
      If Trim(cpd.Fields("cod_embal")) <> Trim(emb.Fields("cod_embal")) Then
         txt_diverg = "EMBALAGEM DO ITEM NO LOGIX: " & cpd.Fields("cod_embal") & " ESTÁ DIFERENTE DO EDI: " & emb.Fields("cod_embal")
         GoSub gerar_divergencias
         lgr.Fields("prazos_confirmados") = "N"
         lgr.Fields("tem_diverg") = "S"
      End If
      
      If cpd.Fields("qtd_padr_embal") <> emb.Fields("capac_embal") Then
         txt_diverg = "CAPACIDADE DA EMBALAGEM DO ITEM NO LOGIX: " & cpd.Fields("qtd_padr_embal") & " ESTÁ DIFERENTE DO EDI: " & emb.Fields("capac_embal")
         GoSub gerar_divergencias
         lgr.Fields("prazos_confirmados") = "N"
         lgr.Fields("tem_diverg") = "S"
      End If
   End If
   
Return

gravar_num_registro:
  sql = "select *, rowid registro   " _
      & "  from ethos_edi_pedidos              " _
      & " where cod_empresa    = '" & selemp & "' " _
      & "   and num_pedido     = " & edi.Fields("pedido") & " " _
      & "   and num_seq_pedido = " & edi.Fields("num_seq") & " " _
      & "   and desconsiderado = 'N'  "
  
  If (nre.State) <> adStateClosed Then nre.Close
  
  telacorr = DoEvents
  nre.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
  telacorr = DoEvents
  
  num_reg = nre.Fields("registro")
   
  sql = "update ethos_edi_pedidos " _
      & "   set num_registro = " & num_reg & " " _
      & " where cod_empresa    = '" & selemp & "' " _
      & "   and num_pedido     = " & edi.Fields("pedido") & " " _
      & "   and num_seq_pedido = " & edi.Fields("num_seq") & " " _
      & "   and desconsiderado = 'N'   "
  
  If (nre.State) <> adStateClosed Then nre.Close
   
  telacorr = DoEvents
  nre.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
  telacorr = DoEvents
Return

deletar_divergencias:
   sql = "delete                              " _
       & "  from ethos_edi_div_ped            " _
       & " where cod_empresa    ='" & selemp & "' " _
       & "   and num_pedido     = " & edi.Fields("pedido") & " " _
       & "   and num_seq_pedido = " & edi.Fields("num_seq") & " "
   
   If (div.State) <> adStateClosed Then div.Close
   
   telacorr = DoEvents
   div.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
   telacorr = DoEvents

Return

deletar_grupo_capacidade:
   
   sql = "delete from ethosm_grupo_dia " _
       & " where cod_empresa = '" & selemp & "' " _
       & "   and carga_edi   = '" & Me.data_edi & "' "
       
   If (nre.State) <> adStateClosed Then nre.Close
   
   telacorr = DoEvents
   nre.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
   telacorr = DoEvents
Return


gerar_divergencias:
   sql = "set isolation to dirty read "
   
   If (div.State) <> adStateClosed Then div.Close
   telacorr = DoEvents
   div.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents

   sql = "select max(seq_linha) ult_linha     " _
       & "  from ethos_edi_div_ped            " _
       & " where cod_empresa    ='" & selemp & "' " _
       & "   and num_pedido     = " & edi.Fields("pedido") & " " _
       & "   and num_seq_pedido = " & edi.Fields("num_seq") & " "

   telacorr = DoEvents
   div.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents

   If div.EOF Then
      prox_linha = 0
   Else
      If (IsNull(div.Fields("ult_linha"))) Then
         prox_linha = 0
      Else
         prox_linha = div.Fields("ult_linha")
      End If
   End If
   
   prox_linha = prox_linha + 1
   
   sql = "insert into ethos_edi_div_ped values('" _
       & selemp & "', '" _
       & edi.Fields("pedido") & "', '" _
       & edi.Fields("num_seq") & "', '" _
       & prox_linha & "', '" _
       & txt_diverg & "')"

   If (div.State) <> adStateClosed Then div.Close
   telacorr = DoEvents
   div.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
   telacorr = DoEvents

Return

tem_divergencias:
   sql = "set isolation to dirty read "
   
   If (div.State) <> adStateClosed Then div.Close
   telacorr = DoEvents
   div.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents

   sql = "select count(*) qtde_diverg         " _
       & "  from ethos_edi_div_ped            " _
       & " where cod_empresa    ='" & selemp & "' " _
       & "   and num_pedido     = " & lei.Fields("num_pedido") & " " _
       & "   and num_seq_pedido = " & lei.Fields("num_seq_pedido") & " "

   telacorr = DoEvents
   div.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents

   If div.EOF Then
      tem_diverg = "N"
      Return
   Else
      If (IsNull(div.Fields("qtde_diverg"))) Then
         tem_diverg = "N"
         Return
      End If
      If div.Fields("qtde_diverg") > 0 Then
         tem_diverg = "S"
         Return
      Else
         tem_diverg = "N"
         Return
      End If
   End If
   
      
Return


deletar_tran_arg:
       sql = "delete                                                  " _
           & "  from tran_arg                                         " _
           & " where cod_empresa         = '" & selemp & "'           " _
           & "   and trim(num_programa)  = 'EDIANAPRZ'                " _
           & "   and trim(login_usuario) = '" & Left(nom_usu, 8) & "' "
          
       If (tra.State) <> adStateClosed Then tra.Close
            
       telacorr = DoEvents
       tra.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
       telacorr = DoEvents
Return

libera_saida:
    exibbar = SysCmd(acSysCmdSetStatus, " ")
    If (nre.State) <> adStateClosed Then nre.Close
    Set nre = Nothing
    If (tra.State) <> adStateClosed Then tra.Close
    Set tra = Nothing
    If (edi.State) <> adStateClosed Then edi.Close
    Set edi = Nothing
    If (lgr.State) <> adStateClosed Then lgr.Close
    Set lgr = Nothing
    If (lei.State) <> adStateClosed Then lei.Close
    Set lei = Nothing
    If (div.State) <> adStateClosed Then div.Close
    Set div = Nothing
    If (cpd.State) <> adStateClosed Then cpd.Close
    Set cpd = Nothing
    If (emb.State) <> adStateClosed Then emb.Close
    Set emb = Nothing
    If (gre.State) <> adStateClosed Then gre.Close
    Set gre = Nothing
    If (gdi.State) <> adStateClosed Then gdi.Close
    Set gdi = Nothing
    If (itg.State) <> adStateClosed Then itg.Close
    Set itg = Nothing
    Set connOnLine = Nothing
    DoCmd.Hourglass False
    Call inibir_barra_proc
    Me.carregar_edi.Enabled = True
    Me.sair.Enabled = True
    Me.data_edi.SetFocus
Return


End Sub

Sub exibir_barra_proc()
   Me.ProgressBar1.Visible = True
   Me.perc_pro.Visible = True
   Me.legenda_pro.Visible = True
End Sub

Sub inibir_barra_proc()
   Me.ProgressBar1.Visible = False
   Me.perc_pro.Visible = False
   Me.legenda_pro.Visible = False
End Sub

Sub exibir_legendas()
   Me.caixa_leg1.Visible = True
   Me.leg1.Visible = True
   Me.leg2.Visible = True
   Me.leg3.Visible = True
   Me.leg4.Visible = True
   Me.leg11.Visible = True
   Me.leg12.Visible = True
   Me.leg13.Visible = True
   Me.leg14.Visible = True
End Sub

Sub inibir_legendas()
   Me.caixa_leg1.Visible = False
   Me.leg1.Visible = False
   Me.leg2.Visible = False
   Me.leg3.Visible = False
   Me.leg4.Visible = False
   Me.leg11.Visible = False
   Me.leg12.Visible = False
   Me.leg13.Visible = False
   Me.leg14.Visible = False
End Sub
Sub exibir_funcoes()
    Me.F3.Visible = True
    Me.F4.Visible = True
    Me.F5.Visible = True
    Me.f6.Visible = True
    Me.F8.Visible = True
    Me.F9.Visible = True
    Me.F10.Visible = True
    Me.F11.Visible = True
    Me.F12.Visible = True
    Me.F13.Visible = True
    Me.F14.Visible = True
    Me.F15.Visible = True
    Me.rel_excel.Visible = True
End Sub
Sub inibir_funcoes()
    Me.F3.Visible = False
    Me.F4.Visible = False
    Me.F5.Visible = False
    Me.f6.Visible = False
    Me.F8.Visible = False
    Me.F9.Visible = False
    Me.F10.Visible = False
    Me.F11.Visible = False
    Me.F12.Visible = False
    Me.F13.Visible = False
    Me.F14.Visible = False
    Me.F15.Visible = False
    Me.rel_excel.Visible = False
End Sub
Private Sub ListView1_Click()
    On Error GoTo tratar_erro
    reg_view = ListView1.SelectedItem
    Me.reg_atua_view = reg_view
    Me.ListView1.SetFocus
    Call exibir_funcoes
    Call exibir_legendas
fim:
    Exit Sub
tratar_erro:
    If Err.Number = 91 Then
       Me.data_edi.SetFocus
       Resume fim
    End If
    aviso = Err.Number & " - " & Err.Description
    Call rot_aviso
    Resume fim
End Sub
Sub ativar_destaque_reg()
    cor_anterior = dados_pos.ListSubItems(3).ForeColor
    dados_pos.ListSubItems(2).ForeColor = 8388608
    dados_pos.ListSubItems(3).ForeColor = 8388608
    dados_pos.ListSubItems(4).ForeColor = 8388608
    dados_pos.ListSubItems(2).Bold = True
    dados_pos.ListSubItems(3).Bold = True
    dados_pos.ListSubItems(4).Bold = True
    Me.ListView1.SetFocus
End Sub
Sub desativar_destaque_reg()
    dados_pos.ListSubItems(2).ForeColor = cor_anterior
    dados_pos.ListSubItems(3).ForeColor = cor_anterior
    dados_pos.ListSubItems(4).ForeColor = cor_anterior
    dados_pos.ListSubItems(2).Bold = False
    dados_pos.ListSubItems(3).Bold = False
    dados_pos.ListSubItems(4).Bold = False
    Me.ListView1.SetFocus
End Sub
Private Sub ListView1_keyup(KeyCode As Integer, ByVal Shift As Integer)
   On Error GoTo tratar_erro
   reg_view = ListView1.SelectedItem
   Me.reg_atua_view = reg_view
   Set dados_pos = ListView1.ListItems.ITEM(reg_view)
fim:
    Exit Sub
tratar_erro:
    If Err.Number = 91 Then
       Me.data_edi.SetFocus
       Resume fim
    End If
    aviso = Err.Number & " - " & Err.Description
    Call rot_aviso
    Resume fim
End Sub
Private Sub F3_Click()
   exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
   reg_view = ListView1.SelectedItem
   Me.reg_atua_view = reg_view
   Set dados_pos = ListView1.ListItems.ITEM(reg_view)
   Me.reg_logico = dados_pos.SubItems(1)
   
   Call verifica_sit_tempos
   If alterar_tempos = "N" Then
      Me.ListView1.SetFocus
      Exit Sub
   End If
   
   registro_em_uso = "N"
   Call travar_opcao
   If registro_em_uso = "S" Then
      ListView1.SetFocus
      Exit Sub
   End If
   
   Me.cselemp = selemp
   Me.cnom_usu = nom_usu
   Call ativar_destaque_reg
   DoCmd.OpenForm "f3_alt_tempos"
   Call desativar_destaque_reg
End Sub
Private Sub F5_Click()
   exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
   reg_view = ListView1.SelectedItem
   Me.reg_atua_view = reg_view
   Set dados_pos = ListView1.ListItems.ITEM(reg_view)
   
   Me.reg_logico = dados_pos.SubItems(1)
   Me.ListView1.SetFocus
   registro_em_uso = "N"
   Call travar_opcao
   If registro_em_uso = "S" Then
      ListView1.SetFocus
      Exit Sub
   End If
   Me.cselemp = selemp
   Me.cnom_usu = nom_usu
   Call ativar_destaque_reg
   DoCmd.OpenForm "f5_observa"
   Call desativar_destaque_reg
End Sub
Private Sub F6_Click()
      exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
      reg_view = ListView1.SelectedItem
      Me.reg_atua_view = reg_view
      Set dados_pos = ListView1.ListItems.ITEM(reg_view)
      
      Call ativar_destaque_reg
      Me.reg_logico = dados_pos.SubItems(1)
      Me.cselemp = selemp
      Me.cnom_usu = nom_usu
      exibbar = SysCmd(acSysCmdSetStatus, "  ")
      DoCmd.OpenForm "f6_diverg"
      Call desativar_destaque_reg
End Sub
Private Sub F8_Click()
      exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
      reg_view = ListView1.SelectedItem
      Me.reg_atua_view = reg_view
      Set dados_pos = ListView1.ListItems.ITEM(reg_view)
      Me.reg_logico = dados_pos.SubItems(1)

      prz_confirmado = "N"
      Call verifica_prz_confirmado
      If prz_confirmado = "S" Then
         ListView1.SetFocus
         Exit Sub
      End If
      registro_em_uso = "N"
      Call travar_opcao
      If registro_em_uso = "S" Then
         ListView1.SetFocus
         Exit Sub
      End If
      Call ativar_destaque_reg
      pergunta = MsgBox("CONFIRMAR ESTE PEDIDO/ITEM ?", vbYesNo + vbDefaultButton2, "ATENÇÃO")
      If pergunta = vbYes Then
         Call confirmar_prazos
         Call ler_dados_view
         Call retorna_linha_destaque
      End If
      Call prep_saida
      If pergunta = vbNo Then Call desativar_destaque_reg
End Sub
Private Sub F9_Click()
      exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
      reg_view = ListView1.SelectedItem
      Me.reg_atua_view = reg_view
      Set dados_pos = ListView1.ListItems.ITEM(reg_view)
      Me.reg_logico = dados_pos.SubItems(1)

      Call verifica_sit_prz
      If prz_confirmado = "N" Then
         ListView1.SetFocus
         Exit Sub
      End If
      registro_em_uso = "N"
      Call travar_opcao
      If registro_em_uso = "S" Then
         ListView1.SetFocus
         Exit Sub
      End If
      Call ativar_destaque_reg
      pergunta = MsgBox("REVOGAR ESTE PEDIDO/ITEM ?", vbYesNo + vbDefaultButton2, "ATENÇÃO")
      If pergunta = vbYes Then
         Call revogar_prazos
         Call desativar_destaque_reg
         Call ler_dados_view
         Call retorna_linha_destaque
      End If
      Call prep_saida
      If pergunta = vbNo Then Call desativar_destaque_reg
End Sub
Private Sub F10_Click()
      exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
      reg_view = ListView1.SelectedItem
      Me.reg_atua_view = reg_view
      Set dados_pos = ListView1.ListItems.ITEM(reg_view)
      Me.reg_logico = dados_pos.SubItems(1)

      Call verifica_sit_desc
      If permitido = "N" Then
         ListView1.SetFocus
         Exit Sub
      End If
      registro_em_uso = "N"
      Call travar_opcao
      If registro_em_uso = "S" Then
         ListView1.SetFocus
         Exit Sub
      End If
      Call ativar_destaque_reg
      pergunta = MsgBox("DESCONSIDERAR ESTE PEDIDO/ITEM ?", vbYesNo + vbDefaultButton2, "ATENÇÃO")
      If pergunta = vbYes Then
         exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
         Call desconsiderar_ped
         Call desativar_destaque_reg
         Call ler_dados_view
         Call retorna_linha_destaque
      End If
      Call prep_saida
      If pergunta = vbNo Then Call desativar_destaque_reg
      exibbar = SysCmd(acSysCmdSetStatus, "  ")
End Sub
Private Sub F11_Click()
      exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
      reg_view = ListView1.SelectedItem
      Me.reg_atua_view = reg_view
      Set dados_pos = ListView1.ListItems.ITEM(reg_view)
      Me.reg_logico = dados_pos.SubItems(1)


      Call verifica_sit_ndesc
      If permitido = "N" Then
         ListView1.SetFocus
         Exit Sub
      End If
      
      registro_em_uso = "N"
      Call travar_opcao
      If registro_em_uso = "S" Then
         ListView1.SetFocus
         Exit Sub
      End If
      Call ativar_destaque_reg
      pergunta = MsgBox("RECONSIDERAR ESTE PEDIDO/ITEM ?", vbYesNo + vbDefaultButton2, "ATENÇÃO")
      If pergunta = vbYes Then
         exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
         Call reconsiderar_ped
         Call desativar_destaque_reg
         Call ler_dados_view
         Call retorna_linha_destaque
      End If
      Call prep_saida
      If pergunta = vbNo Then Call desativar_destaque_reg
      exibbar = SysCmd(acSysCmdSetStatus, "  ")
End Sub
Sub travar_opcao()
    registro_em_uso = "N"
    DoCmd.Hourglass True
    exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
    cam_arqs = Trim(CurrentDbDir)
    Set connOnLine = New ADODB.Connection
    connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
    Set lgr = New ADODB.Recordset
    Set lei = New ADODB.Recordset
    Set gra = New ADODB.Recordset
    
    DoCmd.Hourglass False

    sql = "select *                                                " _
        & "  from ethos_edi_pedidos                                " _
        & " where cod_empresa         = '" & selemp & "'           " _
        & "   and num_registro        = " & Me.reg_logico & "      "
       
    If (lgr.State) <> adStateClosed Then lgr.Close
            
    telacorr = DoEvents
    lgr.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
    telacorr = DoEvents

    If lgr.EOF Then
       aviso = "PEDIDO BLOQUEADO, AGUARDE ALGUNS INSTANTES E TENTE MAIS TARDE!!"
       Call rot_aviso
       registro_em_uso = "S"
       GoSub libera_saida
       Exit Sub
    End If
       

    If Not lgr.EOF Then
       If Not (IsNull(lgr.Fields("registro_em_uso"))) Then
          aviso = "PEDIDO: " & lgr.Fields("num_pedido") & " SEQUENCIA: " & lgr.Fields("num_seq_pedido") & ", " _
                & "EM USO PELO USUÁRIO: '" & Trim(lgr.Fields("registro_em_uso")) & "', " _
                & "AGUARDE ALGUNS INSTANTES, E TENTE MAIS TARDE!!"
          Call rot_aviso
          GoSub libera_saida
          registro_em_uso = "S"
          Exit Sub
       End If
       
       sql = "update ethos_edi_pedidos                " _
           & "   set registro_em_uso = '" & nom_usu & "' " _
           & " where cod_empresa = '" & lgr.Fields("cod_empresa") & "' " _
           & "   and num_registro = " & lgr.Fields("num_registro")
           
       If (gra.State) <> adStateClosed Then gra.Close
            
       telacorr = DoEvents
       gra.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
       telacorr = DoEvents
    End If
    
    GoSub libera_saida

Exit Sub

libera_saida:
    exibbar = SysCmd(acSysCmdSetStatus, " ")
    If (lei.State) <> adStateClosed Then lei.Close
    Set lei = Nothing
    If (lgr.State) <> adStateClosed Then lgr.Close
    Set lgr = Nothing
    If (gra.State) <> adStateClosed Then gra.Close
    Set gra = Nothing
    Set connOnLine = Nothing
    DoCmd.Hourglass False
Return


End Sub
Sub prep_saida()
    registro_em_uso = "N"
    DoCmd.Hourglass True
    exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
    cam_arqs = Trim(CurrentDbDir)
    Set connOnLine = New ADODB.Connection
    connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
    Set lgr = New ADODB.Recordset
    DoCmd.Hourglass False

    sql = "update ethos_edi_pedidos                                        " _
        & "   set registro_em_uso = null                                   " _
        & " where cod_empresa         = '" & selemp & "'  " _
        & "   and num_registro        = " & Me.reg_logico & " "
    
    If (lgr.State) <> adStateClosed Then lgr.Close
            
    telacorr = DoEvents
    lgr.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
    telacorr = DoEvents

    If (lgr.State) <> adStateClosed Then lgr.Close
    Set lgr = Nothing
    Set connOnLine = Nothing
    exibbar = SysCmd(acSysCmdSetStatus, "  ")
    DoCmd.Hourglass False
End Sub

Sub ler_dados_view()
    DoCmd.Hourglass True
    exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, LENDO DADOS - LOGIX ...")
    cam_arqs = Trim(CurrentDbDir)
    Set connOnLine = New ADODB.Connection
    connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
    Set lei = New ADODB.Recordset

   sql = "set isolation to dirty read "
   If (lei.State) <> adStateClosed Then lei.Close
       
   telacorr = DoEvents
   lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents

   If o_que_sera_exibido = "T" Then
      sql = "select *                 " _
          & "  from ethos_edi_pedidos " _
          & " where cod_empresa    = '" & selemp & "' " _
          & "   and dat_carga_edi = '" & Format(Me.data_edi, "dd/mm/yyyy") & "' " _
          & " order by 1,33,3,4,9 "
   End If
   
   If o_que_sera_exibido = "D" Then
      sql = "select *                 " _
          & "  from ethos_edi_pedidos " _
          & " where cod_empresa        = '" & selemp & "' " _
          & "   and dat_carga_edi      = '" & Format(Me.data_edi, "dd/mm/yyyy") & "' " _
          & "   and tem_diverg         = 'S' " _
          & "   and prazos_confirmados = 'N' " _
          & "   and desconsiderado     = 'N' " _
          & " order by 1,33,3,4,9 "
   End If
   
   If o_que_sera_exibido = "O" Then
      sql = "select *                 " _
          & "  from ethos_edi_pedidos " _
          & " where cod_empresa        = '" & selemp & "' " _
          & "   and dat_carga_edi      = '" & Format(Me.data_edi, "dd/mm/yyyy") & "' " _
          & "   and prazos_confirmados = 'S' " _
          & "   and desconsiderado     = 'N' " _
          & " order by 1,33,3,4,9 "
   End If
   
   telacorr = DoEvents
   lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents

   If Not lei.EOF Then Call exibir_legendas
   qtd_reg_proc = 1
   ListView1.ListItems.Clear
   Do While Not lei.EOF
      Set li = ListView1.ListItems.Add(, , qtd_reg_proc)
      li.SubItems(1) = lei.Fields("num_registro")
      li.SubItems(2) = lei.Fields("carregado")
      li.SubItems(3) = lei.Fields("num_pedido")
      li.SubItems(4) = lei.Fields("num_seq_pedido")
      li.SubItems(5) = lei.Fields("tem_obs")
      li.SubItems(6) = lei.Fields("tem_diverg")
      li.SubItems(7) = lei.Fields("amostra")
      li.SubItems(8) = Trim(lei.Fields("cod_item_cliente"))
      li.SubItems(9) = Trim(lei.Fields("cod_item"))
      If (IsNull(Trim(lei.Fields("tamanho_etapa")))) Then
         li.SubItems(10) = "  "
      Else
         li.SubItems(10) = Trim(lei.Fields("tamanho_etapa"))
      End If
      li.SubItems(11) = lei.Fields("den_item_reduz")
      li.SubItems(12) = lei.Fields("dat_abertura")
      li.SubItems(13) = lei.Fields("ship_date_cli")
      If (IsNull(lei.Fields("ship_date_sug"))) Then
          li.SubItems(14) = "          "
      Else
          li.SubItems(14) = lei.Fields("ship_date_sug")
          li.ListSubItems(14).ForeColor = 32896
          li.ListSubItems(14).Bold = True
      End If
      li.SubItems(15) = lei.Fields("qtd_aceita_cli")
      li.SubItems(16) = lei.Fields("sit_gerada_edi")
      li.SubItems(17) = Left(lei.Fields("tipo_pedido"), 2)
      li.SubItems(18) = lei.Fields("qtd_dias_pad_tp_ped")
      li.SubItems(19) = lei.Fields("qtd_dias_ute_tp_ped")
      li.SubItems(20) = lei.Fields("qtd_dias_neces_produ")
      If lei.Fields("qtd_dias_neces_produ") > 0 Then
         li.SubItems(21) = lei.Fields("dat_inicio_producao")
         li.SubItems(22) = lei.Fields("dat_fim_producao")
      Else
         li.SubItems(21) = ""
         li.SubItems(22) = ""
      End If
      If (IsNull(lei.Fields("dat_inicio_prd_recal"))) Then
         li.SubItems(23) = " "
      Else
         li.SubItems(23) = lei.Fields("dat_inicio_prd_recal")
         li.ListSubItems(23).ForeColor = 32896
         li.ListSubItems(23).Bold = True
      End If
      
      If (IsNull(lei.Fields("dat_fim_prod_recal"))) Then
         li.SubItems(24) = " "
      Else
         li.SubItems(24) = lei.Fields("dat_fim_prod_recal")
         li.ListSubItems(24).ForeColor = 32896
         li.ListSubItems(24).Bold = True
      End If
      li.SubItems(25) = lei.Fields("cliente_raz_reduz")
    
      If lei.Fields("tem_diverg") = "S" And lei.Fields("prazos_confirmados") = "N" Then GoSub passa_para_vermelho
      If lei.Fields("tem_diverg") = "S" And lei.Fields("prazos_confirmados") = "S" Then GoSub passa_para_verde
      If lei.Fields("desconsiderado") = "S" Then GoSub passa_para_cinza
      
      lei.MoveNext
      If lei.EOF Then Exit Do
      qtd_reg_proc = qtd_reg_proc + 1
   Loop
   Me.reg_atua_view = 1
   Me.tot_reg_view = qtd_reg_proc

   If (lei.State) <> adStateClosed Then lei.Close
   Set lei = Nothing
   Set connOnLine = Nothing
   exibbar = SysCmd(acSysCmdSetStatus, "  ")
   DoCmd.Hourglass False
Exit Sub
   
'pedido confirmado
passa_para_verde:
    li.ListSubItems(1).ForeColor = 6723891
    li.ListSubItems(2).ForeColor = 6723891
    li.ListSubItems(3).ForeColor = 6723891
    li.ListSubItems(4).ForeColor = 6723891
    li.ListSubItems(5).ForeColor = 6723891
    li.ListSubItems(6).ForeColor = 6723891
    li.ListSubItems(7).ForeColor = 6723891
    li.ListSubItems(8).ForeColor = 6723891
    li.ListSubItems(9).ForeColor = 6723891
    li.ListSubItems(10).ForeColor = 6723891
    li.ListSubItems(11).ForeColor = 6723891
    li.ListSubItems(12).ForeColor = 6723891
    li.ListSubItems(13).ForeColor = 6723891
    li.ListSubItems(15).ForeColor = 6723891
    li.ListSubItems(16).ForeColor = 6723891
    li.ListSubItems(17).ForeColor = 6723891
    li.ListSubItems(18).ForeColor = 6723891
    li.ListSubItems(19).ForeColor = 6723891
    li.ListSubItems(20).ForeColor = 6723891
    li.ListSubItems(21).ForeColor = 6723891
    li.ListSubItems(22).ForeColor = 6723891
    li.ListSubItems(25).ForeColor = 6723891
Return

'pedido com divergencia e não confirmado
passa_para_vermelho:
    li.ListSubItems(1).ForeColor = 255
    li.ListSubItems(2).ForeColor = 255
    li.ListSubItems(3).ForeColor = 255
    li.ListSubItems(4).ForeColor = 255
    li.ListSubItems(5).ForeColor = 255
    li.ListSubItems(6).ForeColor = 255
    li.ListSubItems(7).ForeColor = 255
    li.ListSubItems(8).ForeColor = 255
    li.ListSubItems(9).ForeColor = 255
    li.ListSubItems(10).ForeColor = 255
    li.ListSubItems(11).ForeColor = 255
    li.ListSubItems(12).ForeColor = 255
    li.ListSubItems(13).ForeColor = 255
    li.ListSubItems(15).ForeColor = 255
    li.ListSubItems(16).ForeColor = 255
    li.ListSubItems(17).ForeColor = 255
    li.ListSubItems(18).ForeColor = 255
    li.ListSubItems(19).ForeColor = 255
    li.ListSubItems(20).ForeColor = 255
    li.ListSubItems(21).ForeColor = 255
    li.ListSubItems(22).ForeColor = 255
    li.ListSubItems(25).ForeColor = 255
    li.ListSubItems(25).ForeColor = 255
Return
   
'pedido desconsiderado
passa_para_cinza:
    li.ListSubItems(1).ForeColor = 12632256
    li.ListSubItems(1).Bold = True
    li.ListSubItems(2).ForeColor = 12632256
    li.ListSubItems(2).Bold = True
    li.ListSubItems(3).ForeColor = 12632256
    li.ListSubItems(3).Bold = True
    li.ListSubItems(4).ForeColor = 12632256
    li.ListSubItems(4).Bold = True
    li.ListSubItems(5).ForeColor = 12632256
    li.ListSubItems(5).Bold = True
    li.ListSubItems(6).ForeColor = 12632256
    li.ListSubItems(6).Bold = True
    li.ListSubItems(7).ForeColor = 12632256
    li.ListSubItems(7).Bold = True
    li.ListSubItems(8).ForeColor = 12632256
    li.ListSubItems(8).Bold = True
    li.ListSubItems(9).ForeColor = 12632256
    li.ListSubItems(9).Bold = True
    li.ListSubItems(10).ForeColor = 12632256
    li.ListSubItems(10).Bold = True
    li.ListSubItems(11).ForeColor = 12632256
    li.ListSubItems(11).Bold = True
    li.ListSubItems(12).ForeColor = 12632256
    li.ListSubItems(12).Bold = True
    li.ListSubItems(13).ForeColor = 12632256
    li.ListSubItems(13).Bold = True
    li.ListSubItems(14).ForeColor = 12632256
    li.ListSubItems(14).Bold = True
    li.ListSubItems(15).ForeColor = 12632256
    li.ListSubItems(15).Bold = True
    li.ListSubItems(16).ForeColor = 12632256
    li.ListSubItems(16).Bold = True
    li.ListSubItems(17).ForeColor = 12632256
    li.ListSubItems(17).Bold = True
    li.ListSubItems(18).ForeColor = 12632256
    li.ListSubItems(18).Bold = True
    li.ListSubItems(19).ForeColor = 12632256
    li.ListSubItems(19).Bold = True
    li.ListSubItems(20).ForeColor = 12632256
    li.ListSubItems(20).Bold = True
    li.ListSubItems(21).ForeColor = 12632256
    li.ListSubItems(21).Bold = True
    li.ListSubItems(22).ForeColor = 12632256
    li.ListSubItems(22).Bold = True
    li.ListSubItems(23).ForeColor = 12632256
    li.ListSubItems(23).Bold = True
    li.ListSubItems(24).ForeColor = 12632256
    li.ListSubItems(24).Bold = True
    li.ListSubItems(25).ForeColor = 12632256
    li.ListSubItems(25).Bold = True
Return
   
   
End Sub
Sub retorna_linha_destaque()
  If o_que_sera_exibido = "O" Or o_que_sera_exibido = "D" And reg_view <> 1 Then reg_view = reg_view - 1
  ListView1.ListItems.ITEM(reg_view).Selected = True
  ListView1.ListItems.ITEM(reg_view).EnsureVisible
  ListView1.SetFocus
  reg_view = ListView1.SelectedItem
  Me.reg_atua_view = reg_view
  Set dados_pos = ListView1.ListItems.ITEM(reg_view)
End Sub
Sub confirmar_prazos()
    DoCmd.Hourglass True
    exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
    cam_arqs = Trim(CurrentDbDir)
    Set connOnLine = New ADODB.Connection
    connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
    Set lgr = New ADODB.Recordset
    DoCmd.Hourglass False

    sql = "update ethos_edi_pedidos                       " _
        & "   set prazos_confirmados  = 'S',              " _
        & "       alterado = 'S'                          " _
        & " where cod_empresa         = '" & selemp & "'  " _
        & "   and num_registro        = " & Me.reg_logico & " "
    
    If (lgr.State) <> adStateClosed Then lgr.Close
            
    telacorr = DoEvents
    lgr.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
    telacorr = DoEvents

    sql = "insert into audit_vdp values('" _
        & selemp & "', '" _
        & dados_pos.SubItems(3) & "', '" _
        & "C" & "', '" _
        & "A" & "', '" _
        & "SEQUENCIA " & dados_pos.SubItems(4) & " CONFIRMAÇÃO REALIZADA', '" _
        & "EDIANAPRZ', '" _
        & Format(Date, "dd/mm/yyyy") & "', '" _
        & Format(Time, "hh:mm:ss") & "', '" _
        & Trim(Left(nom_usu, 8)) & "', '" _
        & "0')"
        
    If (lgr.State) <> adStateClosed Then lgr.Close
            
    telacorr = DoEvents
    lgr.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
    telacorr = DoEvents


    If (lgr.State) <> adStateClosed Then lgr.Close
    Set lgr = Nothing
    Set connOnLine = Nothing
    exibbar = SysCmd(acSysCmdSetStatus, "  ")
    DoCmd.Hourglass False
End Sub
Sub verifica_prz_confirmado()
    prz_confirmado = "N"
    DoCmd.Hourglass True
    exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
    cam_arqs = Trim(CurrentDbDir)
    Set connOnLine = New ADODB.Connection
    connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
    Set lei = New ADODB.Recordset
    DoCmd.Hourglass False

    sql = "set isolation to dirty read "
    If (lei.State) <> adStateClosed Then lei.Close
      
    telacorr = DoEvents
    lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
    telacorr = DoEvents
    
    sql = "select *                                                " _
        & "  from ethos_edi_pedidos                                " _
        & " where cod_empresa         = '" & selemp & "'           " _
        & "   and num_registro        = " & Me.reg_logico & "      " _
        & "   and prazos_confirmados  = 'N'                        " _
        & "   and tem_diverg          = 'S'                        " _
        & "   and desconsiderado      = 'N'                        " _

    telacorr = DoEvents
    lei.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
    telacorr = DoEvents

    If Not lei.EOF Then
       prz_confirmado = "N"
    Else
       aviso = "OPERAÇÃO INVALIDA!!  PEDIDO NÃO ESTÁ EM SITUAÇÃO PERMITIDA PARA ESTA OPERAÇÃO!!"
       Call rot_aviso
       prz_confirmado = "S"
    End If

    If (lei.State) <> adStateClosed Then lei.Close
    Set lei = Nothing
    Set connOnLine = Nothing
    exibbar = SysCmd(acSysCmdSetStatus, "  ")
    DoCmd.Hourglass False
End Sub
Sub verifica_sit_prz()
    prz_confirmado = "N"
    DoCmd.Hourglass True
    exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
    cam_arqs = Trim(CurrentDbDir)
    Set connOnLine = New ADODB.Connection
    connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
    Set lei = New ADODB.Recordset
    DoCmd.Hourglass False

    sql = "select *                                                " _
        & "  from ethos_edi_pedidos                                " _
        & " where cod_empresa         = '" & selemp & "'           " _
        & "   and num_registro        = " & Me.reg_logico & "      " _
        & "   and prazos_confirmados  = 'S'                        " _
        & "   and tem_diverg          = 'S'                        " _
        & "   and desconsiderado      = 'N'                        "
       
    If (lei.State) <> adStateClosed Then lei.Close
            
    telacorr = DoEvents
    lei.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
    telacorr = DoEvents

    If Not lei.EOF Then
       prz_confirmado = "S"
    Else
       prz_confirmado = "N"
       aviso = "OPERAÇÃO INVALIDA!!  PEDIDO NÃO ESTÁ EM SITUAÇÃO PERMITIDA PARA ESTA OPERAÇÃO!!"
       Call rot_aviso
    End If

    If (lei.State) <> adStateClosed Then lei.Close
    Set lei = Nothing
    Set connOnLine = Nothing
    exibbar = SysCmd(acSysCmdSetStatus, "  ")
    DoCmd.Hourglass False
End Sub
Sub revogar_prazos()
    DoCmd.Hourglass True
    exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
    cam_arqs = Trim(CurrentDbDir)
    Set connOnLine = New ADODB.Connection
    connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
    Set lgr = New ADODB.Recordset
    DoCmd.Hourglass False

    sql = "update ethos_edi_pedidos                       " _
        & "   set prazos_confirmados  = 'N'               " _
        & " where cod_empresa         = '" & selemp & "'  " _
        & "   and num_registro        = " & Me.reg_logico & " "
    
    If (lgr.State) <> adStateClosed Then lgr.Close
            
    telacorr = DoEvents
    lgr.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
    telacorr = DoEvents

    sql = "insert into audit_vdp values('" _
        & selemp & "', '" _
        & dados_pos.SubItems(3) & "', '" _
        & "C" & "', '" _
        & "A" & "', '" _
        & "SEQUENCIA " & dados_pos.SubItems(4) & " REVOGAÇÃO REALIZADA', '" _
        & "EDIANAPRZ', '" _
        & Format(Date, "dd/mm/yyyy") & "', '" _
        & Format(Time, "hh:mm:ss") & "', '" _
        & Trim(Left(nom_usu, 8)) & "', '" _
        & "0')"
        
    If (lgr.State) <> adStateClosed Then lgr.Close
            
    telacorr = DoEvents
    lgr.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
    telacorr = DoEvents


    If (lgr.State) <> adStateClosed Then lgr.Close
    Set lgr = Nothing
    Set connOnLine = Nothing
    exibbar = SysCmd(acSysCmdSetStatus, "  ")
    DoCmd.Hourglass False
End Sub

Sub verifica_sit_tempos()
    alterar_tempos = "S"
    DoCmd.Hourglass True
    exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
    cam_arqs = Trim(CurrentDbDir)
    Set connOnLine = New ADODB.Connection
    connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
    Set lei = New ADODB.Recordset
    DoCmd.Hourglass False

    sql = "set isolation to dirty read "
    If (lei.State) <> adStateClosed Then lei.Close
      
    telacorr = DoEvents
    lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
    telacorr = DoEvents

    sql = "select *                                                " _
        & "  from ethos_edi_pedidos                                " _
        & " where cod_empresa         = '" & selemp & "'           " _
        & "   and num_registro        = " & Me.reg_logico & "      " _
        & "   and tem_diverg          = 'S'                        " _
        & "   and prazos_confirmados  = 'N'                        " _
        & "   and desconsiderado      = 'N'                        "
       
    If (lei.State) <> adStateClosed Then lei.Close
            
    telacorr = DoEvents
    lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
    telacorr = DoEvents

    If Not lei.EOF Then
       alterar_tempos = "S"
    Else
       alterar_tempos = "N"
       aviso = "OPERAÇÃO INVALIDA!!  PEDIDO NÃO ESTÁ EM SITUAÇÃO PERMITIDA PARA ESTA OPERAÇÃO!!"
       Call rot_aviso
    End If

    If (lei.State) <> adStateClosed Then lei.Close
    Set lei = Nothing
    Set connOnLine = Nothing
    exibbar = SysCmd(acSysCmdSetStatus, "  ")
    DoCmd.Hourglass False
End Sub
Sub verifica_sit_desc()
    permitido = "N"
    DoCmd.Hourglass True
    exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
    cam_arqs = Trim(CurrentDbDir)
    Set connOnLine = New ADODB.Connection
    connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
    Set lei = New ADODB.Recordset
    DoCmd.Hourglass False

    sql = "select *                                                " _
        & "  from ethos_edi_pedidos                                " _
        & " where cod_empresa         = '" & selemp & "'           " _
        & "   and num_registro        = " & Me.reg_logico & "      " _
        & "   and desconsiderado      = 'N'                        "
       
    If (lei.State) <> adStateClosed Then lei.Close
            
    telacorr = DoEvents
    lei.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
    telacorr = DoEvents

    If Not lei.EOF Then
       permitido = "S"
       GoSub verifica_exist_desconsiderado
    Else
       permitido = "N"
       aviso = "OPERAÇÃO INVALIDA!!  PEDIDO NÃO ESTÁ EM SITUAÇÃO PERMITIDA PARA ESTA OPERAÇÃO!!"
       Call rot_aviso
    End If

    If (lei.State) <> adStateClosed Then lei.Close
    Set lei = Nothing
    Set connOnLine = Nothing
    exibbar = SysCmd(acSysCmdSetStatus, "  ")
    DoCmd.Hourglass False
Exit Sub
verifica_exist_desconsiderado:
    
    sql = "select *                                                " _
        & "  from ethos_edi_pedidos                                " _
        & " where cod_empresa         = '" & selemp & "'           " _
        & "   and num_pedido          = " & lei.Fields("num_pedido") & " " _
        & "   and num_seq_pedido      = " & lei.Fields("num_seq_pedido") & " " _
        & "   and desconsiderado      = 'S'                        "

    If (lei.State) <> adStateClosed Then lei.Close
            
    telacorr = DoEvents
    lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
    telacorr = DoEvents

    If Not lei.EOF Then
       permitido = "N"
       aviso = "OPERAÇÃO INVALIDA!!  JÁ EXISTEM ESTE PEDIDO DESCONSIDERADO!!"
       Call rot_aviso
    End If

Return

End Sub
Sub desconsiderar_ped()
    DoCmd.Hourglass True
    exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
    cam_arqs = Trim(CurrentDbDir)
    Set connOnLine = New ADODB.Connection
    connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
    Set lgr = New ADODB.Recordset
    DoCmd.Hourglass False

    sql = "update ethos_edi_pedidos                       " _
        & "   set desconsiderado  = 'S'                   " _
        & " where cod_empresa         = '" & selemp & "'  " _
        & "   and num_registro        = " & Me.reg_logico & " "
    
    If (lgr.State) <> adStateClosed Then lgr.Close
            
    telacorr = DoEvents
    lgr.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
    telacorr = DoEvents

    sql = "insert into audit_vdp values('" _
        & selemp & "', '" _
        & dados_pos.SubItems(3) & "', '" _
        & "C" & "', '" _
        & "A" & "', '" _
        & "SEQUENCIA " & dados_pos.SubItems(4) & " DESCONSIDERAÇÃO REALIZADA', '" _
        & "EDIANAPRZ', '" _
        & Format(Date, "dd/mm/yyyy") & "', '" _
        & Format(Time, "hh:mm:ss") & "', '" _
        & Trim(Left(nom_usu, 8)) & "', '" _
        & "0')"
        
    If (lgr.State) <> adStateClosed Then lgr.Close
            
    telacorr = DoEvents
    lgr.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
    telacorr = DoEvents


    If (lgr.State) <> adStateClosed Then lgr.Close
    Set lgr = Nothing
    Set connOnLine = Nothing
    exibbar = SysCmd(acSysCmdSetStatus, "  ")
    DoCmd.Hourglass False
End Sub
Sub verifica_sit_ndesc()
    permitido = "N"
    DoCmd.Hourglass True
    exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
    cam_arqs = Trim(CurrentDbDir)
    Set connOnLine = New ADODB.Connection
    connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
    Set lei = New ADODB.Recordset
    DoCmd.Hourglass False

    sql = "select *                                                " _
        & "  from ethos_edi_pedidos                                " _
        & " where cod_empresa         = '" & selemp & "'           " _
        & "   and num_registro        = " & Me.reg_logico & "      " _
        & "   and desconsiderado      = 'S'                        "
       
    If (lei.State) <> adStateClosed Then lei.Close
            
    telacorr = DoEvents
    lei.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
    telacorr = DoEvents

    If Not lei.EOF Then
       permitido = "S"
       GoSub verifica_exist_considerado
    Else
       permitido = "N"
       aviso = "OPERAÇÃO INVALIDA!!  PEDIDO NÃO ESTÁ EM SITUAÇÃO PERMITIDA PARA ESTA OPERAÇÃO!!"
       Call rot_aviso
    End If

    If (lei.State) <> adStateClosed Then lei.Close
    Set lei = Nothing
    Set connOnLine = Nothing
    exibbar = SysCmd(acSysCmdSetStatus, "  ")
    DoCmd.Hourglass False
Exit Sub

verifica_exist_considerado:
    
    sql = "select *                                                " _
        & "  from ethos_edi_pedidos                                " _
        & " where cod_empresa         = '" & selemp & "'           " _
        & "   and num_pedido          = " & lei.Fields("num_pedido") & " " _
        & "   and num_seq_pedido      = " & lei.Fields("num_seq_pedido") & " " _
        & "   and desconsiderado      = 'N'                        "

    If (lei.State) <> adStateClosed Then lei.Close
            
    telacorr = DoEvents
    lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
    telacorr = DoEvents

    If Not lei.EOF Then
       permitido = "N"
       aviso = "OPERAÇÃO INVALIDA!!  JÁ EXISTEM ESTE PEDIDO CONSIDERADO!!"
       Call rot_aviso
    End If

Return

End Sub
Sub reconsiderar_ped()
    DoCmd.Hourglass True
    exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, PROCESSANDO INFORMAÇÕES DO PEDIDO ...")
    cam_arqs = Trim(CurrentDbDir)
    Set connOnLine = New ADODB.Connection
    connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
    Set lgr = New ADODB.Recordset
    DoCmd.Hourglass False

    sql = "update ethos_edi_pedidos                       " _
        & "   set desconsiderado  = 'N'                   " _
        & " where cod_empresa         = '" & selemp & "'  " _
        & "   and num_registro        = " & Me.reg_logico & " "
    
    If (lgr.State) <> adStateClosed Then lgr.Close
            
    telacorr = DoEvents
    lgr.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
    telacorr = DoEvents

    sql = "insert into audit_vdp values('" _
        & selemp & "', '" _
        & dados_pos.SubItems(3) & "', '" _
        & "C" & "', '" _
        & "A" & "', '" _
        & "SEQUENCIA " & dados_pos.SubItems(4) & " RECONSIDERAÇÃO REALIZADA', '" _
        & "EDIANAPRZ', '" _
        & Format(Date, "dd/mm/yyyy") & "', '" _
        & Format(Time, "hh:mm:ss") & "', '" _
        & Trim(Left(nom_usu, 8)) & "', '" _
        & "0')"
        
    If (lgr.State) <> adStateClosed Then lgr.Close
            
    telacorr = DoEvents
    lgr.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
    telacorr = DoEvents


    If (lgr.State) <> adStateClosed Then lgr.Close
    Set lgr = Nothing
    Set connOnLine = Nothing
    exibbar = SysCmd(acSysCmdSetStatus, "  ")
    DoCmd.Hourglass False
End Sub
Sub achar_dias_uteis()
     DoCmd.Hourglass True
     exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, VERIFICANDO DIAS ÚTEIS ...")
     cam_arqs = Trim(CurrentDbDir)
     Set connOnLine = New ADODB.Connection
     connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
     Set lei = New ADODB.Recordset
     
     dias_corridos = CVDate(data_ship) - CVDate(data_inicio_edi)
     data_enc = CVDate(data_ship)
     qtde_dias_uteis = 0
     
     For dias_proc = 0 To dias_corridos
         GoSub validar_dia_logix
       
         If o_dia_e_util = "S" Then qtde_dias_uteis = qtde_dias_uteis + 1
         
         data_enc = CVDate(data_enc) - 1
         data_enc = Format(data_enc, "dd/mm/yyyy")
     Next dias_proc
    
     exibbar = SysCmd(acSysCmdSetStatus, "  ")
     If (lei.State) <> adStateClosed Then lei.Close
     Set lei = Nothing
     Set connOnLine = Nothing
     DoCmd.Hourglass False
Exit Sub

validar_dia_logix:
      o_dia_e_util = "S"
      
      GoSub achar_dia_da_semana
       
      sql = "set isolation to dirty read "
      If (lei.State) <> adStateClosed Then lei.Close
      
      telacorr = DoEvents
      lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
      telacorr = DoEvents
      
      sql = "select *                   " _
          & "  from semana_sup          " _
          & " where cod_empresa = '" & selemp & "' " _
          & "   and ies_dia_semana = " & cod_semana
 
      lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   
      If Not lei.EOF Then
         If Not (IsNull(lei.Fields("ies_situa"))) Then
            If lei.Fields("ies_situa") = "3" Then o_dia_e_util = "N"
         End If
      End If
      
      
      If o_dia_e_util = "S" Then
      
         sql = "set isolation to dirty read "
         If (lei.State) <> adStateClosed Then lei.Close
      
         telacorr = DoEvents
         lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
         telacorr = DoEvents
         
         sql = "select *                  " _
             & "  from ethosm_fer_prz     " _
             & " where cod_empresa = '" & selemp & "' " _
             & "   and dat_ref = '" & Format(data_enc, "dd/mm/yyyy") & "' "
  
         lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
                  
         If Not lei.EOF Then o_dia_e_util = "N"
      End If
Return

achar_dia_da_semana:
    dia_semana = StrConv(Format(data_enc, "dddd"), 1)
    If dia_semana = "DOMINGO" Then cod_semana = 0
    If dia_semana = "SEGUNDA-FEIRA" Then cod_semana = 1
    If dia_semana = "TERÇA-FEIRA" Then cod_semana = 2
    If dia_semana = "QUARTA-FEIRA" Then cod_semana = 3
    If dia_semana = "QUINTA-FEIRA" Then cod_semana = 4
    If dia_semana = "SEXTA-FEIRA" Then cod_semana = 5
    If dia_semana = "SÁBADO" Then cod_semana = 6
Return
End Sub
Private Sub F12_Click()
    o_que_sera_exibido = "D"
    Call ler_dados_view
    Me.ListView1.SetFocus
End Sub
Private Sub F13_Click()
    o_que_sera_exibido = "O"
    Call ler_dados_view
    Me.ListView1.SetFocus
End Sub
Private Sub F14_Click()
    o_que_sera_exibido = "T"
    Call ler_dados_view
    Me.ListView1.SetFocus
End Sub
Private Sub F15_Click()
   DoCmd.Hourglass True
   exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, LENDO DADOS - LOGIX ...")
   cam_arqs = Trim(CurrentDbDir)
   Set connOnLine = New ADODB.Connection
   connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
   Set lei = New ADODB.Recordset

  ' MS Access
   Dim wrk      As DAO.Workspace
   Dim db       As DAO.Database
   Set wrk = DBEngine.Workspaces(0)
   Set db = wrk.OpenDatabase(CurrentDb.Name)
   Dim ac       As DAO.Recordset

   sql = "select *                               " _
       & "  from ethos_edi_pedidos               " _
       & "  where cod_empresa    = '" & selemp & "' " _
       & "    and trim(usuario)  = '" & nom_usu & "' " _
       & "    and data_process   = '" & Me.dat_proc & "' " _
       & "    and hora_process   = '" & Me.hor_proc & "' "

   Set ac = db.OpenRecordset(sql, dbOpenDynaset)
   
   Do While Not ac.EOF
      ac.Edit
      ac.Delete
      ac.MoveNext
      If ac.EOF Then Exit Do
   Loop
   
   sql = "set isolation to dirty read "
   If (lei.State) <> adStateClosed Then lei.Close
       
   telacorr = DoEvents
   lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents

   If o_que_sera_exibido = "T" Then
      Me.nome_relatorio = "RELAÇÃO DOS PEDIDOS - EDI DIA: " & Me.data_edi
      sql = "select *                 " _
          & "  from ethos_edi_pedidos " _
          & " where cod_empresa    = '" & selemp & "' " _
          & "   and dat_carga_edi = '" & Format(Me.data_edi, "dd/mm/yyyy") & "' " _
          & " order by 1,8,3,4 "
   End If
   
   If o_que_sera_exibido = "D" Then
      Me.nome_relatorio = "RELAÇÃO DOS PEDIDOS DIVERGENTES - EDI DIA: " & Me.data_edi
      sql = "select *                 " _
          & "  from ethos_edi_pedidos " _
          & " where cod_empresa        = '" & selemp & "' " _
          & "   and dat_carga_edi      = '" & Format(Me.data_edi, "dd/mm/yyyy") & "' " _
          & "   and tem_diverg         = 'S' " _
          & "   and prazos_confirmados = 'N' " _
          & "   and desconsiderado     = 'N' " _
          & " order by 1,8,3,4 "
   End If
   
   If o_que_sera_exibido = "O" Then
      Me.nome_relatorio = "RELAÇÃO DOS PEDIDOS CONFIRMADOS - EDI DIA: " & Me.data_edi
      sql = "select *                 " _
          & "  from ethos_edi_pedidos " _
          & " where cod_empresa        = '" & selemp & "' " _
          & "   and dat_carga_edi      = '" & Format(Me.data_edi, "dd/mm/yyyy") & "' " _
          & "   and prazos_confirmados = 'S' " _
          & "   and desconsiderado     = 'N' " _
          & " order by 1,8,3,4 "
   End If
   
   telacorr = DoEvents
   lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents
   Do While Not lei.EOF
      exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, LENDO DADOS - LOGIX E PREPARANDO RELATÓRIO ..." & lei.Fields("num_pedido") & " - " & lei.Fields("num_seq_pedido"))
      ac.AddNew
      ac.Fields("cod_empresa") = lei.Fields("cod_empresa")
      ac.Fields("usuario") = nom_usu
      ac.Fields("data_process") = Me.dat_proc
      ac.Fields("hora_process") = Me.hor_proc
      ac.Fields("carregado") = lei.Fields("carregado")
      ac.Fields("num_pedido") = lei.Fields("num_pedido")
      ac.Fields("num_seq_pedido") = lei.Fields("num_seq_pedido")
      ac.Fields("cod_item_cliente") = lei.Fields("cod_item_cliente")
      ac.Fields("cod_item") = lei.Fields("cod_item")
      ac.Fields("tamanho_etapa") = lei.Fields("tamanho_etapa")
      ac.Fields("den_item_reduz") = lei.Fields("den_item_reduz")
      ac.Fields("dat_carga_edi") = lei.Fields("dat_carga_edi")
      ac.Fields("dat_abertura") = lei.Fields("dat_abertura")
      ac.Fields("ship_date_cli") = lei.Fields("ship_date_cli")
      ac.Fields("ship_date_sug") = lei.Fields("ship_date_sug")
      ac.Fields("qtd_aceita_cli") = lei.Fields("qtd_aceita_cli")
      ac.Fields("qtd_aceita_sug") = lei.Fields("qtd_aceita_sug")
      ac.Fields("sit_gerada_edi") = lei.Fields("sit_gerada_edi")
      ac.Fields("tipo_pedido") = lei.Fields("tipo_pedido")
      ac.Fields("qtd_dias_pad_tp_ped") = lei.Fields("qtd_dias_pad_tp_ped")
      ac.Fields("qtd_dias_ute_tp_ped") = lei.Fields("qtd_dias_ute_tp_ped")
      ac.Fields("qtd_dias_neces_produ") = lei.Fields("qtd_dias_neces_produ")
      ac.Fields("dat_inicio_producao") = lei.Fields("dat_inicio_producao")
      ac.Fields("dat_inicio_prd_recal") = lei.Fields("dat_inicio_prd_recal")
      ac.Fields("dat_fim_producao") = lei.Fields("dat_fim_producao")
      ac.Fields("dat_fim_prod_recal") = lei.Fields("dat_fim_prod_recal")
      ac.Fields("tem_obs") = lei.Fields("tem_obs")
      ac.Fields("prazos_confirmados") = lei.Fields("prazos_confirmados")
      ac.Fields("amostra") = lei.Fields("amostra")
      ac.Fields("cliente_raz_reduz") = lei.Fields("cliente_raz_reduz")
      ac.Update
      lei.MoveNext
      If lei.EOF Then Exit Do
   Loop


   If (lei.State) <> adStateClosed Then lei.Close
   Set lei = Nothing
   Set connOnLine = Nothing
   ac.Close
   db.Close
   wrk.Close
   Me.data_compl = Format(Date, "dddd") & ", "
   Me.data_compl = Me.data_compl & Format(Date, "d") & " de "
   Me.data_compl = Me.data_compl & Format(Date, "mmmm") & " de "
   Me.data_compl = Me.data_compl & Format(Date, "yyyy")
   Me.data_rel = Me.data_compl & "  às  " & Me.hor_proc
   exibbar = SysCmd(acSysCmdSetStatus, "  ")
   DoCmd.Hourglass False
   DoCmd.OpenReport "rel_edi_pedidos", acViewPreview

End Sub
Sub calcula_prazos()
  'on error GoTo mens_erro
  
  DoCmd.Hourglass True
  exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, INICIANDO O CÁLCULO DA NOVA DA MÍNIMA DE PRODUÇÃO...")
  cam_arqs = Trim(CurrentDbDir)
  Set connOnLine = New ADODB.Connection
  connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
  
  Set con = New ADODB.Recordset
  Set ope = New ADODB.Recordset
  Set prz = New ADODB.Recordset
  Set ddt = New ADODB.Recordset
  Set gdt = New ADODB.Recordset
  Set bdt = New ADODB.Recordset
  Set tmp = New ADODB.Recordset
  Set gut = New ADODB.Recordset
  Set rot = New ADODB.Recordset
  
  Set fl1 = New ADODB.Recordset
  Set fl2 = New ADODB.Recordset
  Set fl3 = New ADODB.Recordset
  Set fl4 = New ADODB.Recordset
  Set fl5 = New ADODB.Recordset
  Set fl6 = New ADODB.Recordset
  Set fl7 = New ADODB.Recordset
  Set fl8 = New ADODB.Recordset
  Set fl9 = New ADODB.Recordset
  Set fl10 = New ADODB.Recordset
  Set fl11 = New ADODB.Recordset
  Set fl12 = New ADODB.Recordset


' nivel 0
  exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", CALCULANDO PRAZO DE PRODUÇÃO...")
  
  NIVEL_COMPON = "00"
  cod_compon = nulo
  pai_acima = nulo
  processei = nulo

  processei = "S"
  NIVEL_COMPON = "00"
  GoSub deleta_gerados
  exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", LENDO ESTRUTURA, ITEM PAI PRINCIPAL... " & pai)
  GoSub busca_operacoes
  GoSub tratar_nivel_1
  GoSub definir_datas
  GoSub finaliza
  GoSub finaliza1
  GoSub finaliza2
  GoSub finaliza2_0
   
  
' busca dias necessários para produzir o item
  sql = "select sum(dias_execucao) dias_necess_producao    " _
      & "  from ethos_edi_opeprazo                         " _
      & " where cod_empresa          = '" & selemp & "'    " _
      & "   and trim(cod_item_princ) = '" & pai_princ & "' " _
      & "   and num_pedido           = " & vnum_pedido & " " _
      & "   and num_seq_pedido       = " & vseq_pedido & " " _
      & "   and num_ordem            = 0 "
   
  dias_neces_prod = 0
  
  If (tmp.State) <> adStateClosed Then tmp.Close
     
  telacorr = DoEvents
  tmp.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
    
  If Not tmp.EOF Then
     dias_neces_prod = tmp.Fields("dias_necess_producao")
  End If
   
   
' busca prazo calculado de inicio de produção a partir da data de entrega do edi
  sql = "select first 1 prazo_operacao inicio_producao     " _
      & "  from ethos_edi_opeprazo                         " _
      & " where cod_empresa          = '" & selemp & "'    " _
      & "   and trim(cod_item_princ) = '" & pai_princ & "' " _
      & "   and num_pedido           = " & vnum_pedido & " " _
      & "   and num_seq_pedido       = " & vseq_pedido & " " _
      & "   and num_ordem            = 0                   " _
      & " order by 1  "
   
  data_calc_ini_prd = Format(data_carga_edi, "dd/mm/yyyy")
  
  If (tmp.State) <> adStateClosed Then tmp.Close
     
  telacorr = DoEvents
  tmp.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
    
  If Not tmp.EOF Then
     data_calc_ini_prd = Format(tmp.Fields("inicio_producao"), "dd/mm/yyyy")
  End If
   
   
' busca prazo calculado do fim da produção a partir da data de entrega do edi
  sql = "select first 1 prazo_operacao fim_producao        " _
      & "  from ethos_edi_opeprazo                         " _
      & " where cod_empresa          = '" & selemp & "'    " _
      & "   and trim(cod_item_princ) = '" & pai_princ & "' " _
      & "   and num_pedido           = " & vnum_pedido & " " _
      & "   and num_seq_pedido       = " & vseq_pedido & " " _
      & "   and num_ordem            = 0                   " _
      & " order by 1 desc "
   
  data_calc_fim_prd = Format(vdat_entrega_princ, "dd/mm/yyyy")
  
  If (tmp.State) <> adStateClosed Then tmp.Close
     
  telacorr = DoEvents
  tmp.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
    
  If Not tmp.EOF Then
     data_calc_fim_prd = Format(tmp.Fields("fim_producao"), "dd/mm/yyyy")
  End If
   
  If (IsNull(data_calc_ini_prd)) Or data_calc_ini_prd = "" Then data_calc_ini_prd = Format(Me.data_edi, "dd/mm/yyyy")
  dias_neces_prod = CVDate(data_calc_fim_prd) - CVDate(data_calc_ini_prd)
   
  If (tmp.State) <> adStateClosed Then tmp.Close
  Set tmp = Nothing
  If (bdt.State) <> adStateClosed Then bdt.Close
  Set bdt = Nothing
  If (ddt.State) <> adStateClosed Then ddt.Close
  Set ddt = Nothing
  If (gdt.State) <> adStateClosed Then gdt.Close
  Set gdt = Nothing
  If (prz.State) <> adStateClosed Then prz.Close
  Set prz = Nothing
  If (con.State) <> adStateClosed Then con.Close
  Set con = Nothing
  If (ope.State) <> adStateClosed Then ope.Close
  Set ope = Nothing
  If (fl1.State) <> adStateClosed Then fl1.Close
  Set fl1 = Nothing
  If (fl2.State) <> adStateClosed Then fl2.Close
  Set fl2 = Nothing
  If (fl3.State) <> adStateClosed Then fl3.Close
  Set fl3 = Nothing
  If (fl4.State) <> adStateClosed Then fl4.Close
  Set fl4 = Nothing
  If (fl5.State) <> adStateClosed Then fl5.Close
  Set fl5 = Nothing
  If (fl6.State) <> adStateClosed Then fl6.Close
  Set fl6 = Nothing
  If (fl7.State) <> adStateClosed Then fl7.Close
  Set fl7 = Nothing
  If (fl8.State) <> adStateClosed Then fl8.Close
  Set fl8 = Nothing
  If (fl9.State) <> adStateClosed Then fl9.Close
  Set fl9 = Nothing
  If (fl10.State) <> adStateClosed Then fl10.Close
  Set fl10 = Nothing
  If (fl11.State) <> adStateClosed Then fl11.Close
  Set fl11 = Nothing
  If (fl12.State) <> adStateClosed Then fl12.Close
  Set fl12 = Nothing
  If (gut.State) <> adStateClosed Then gut.Close
  Set gut = Nothing
  If (rot.State) <> adStateClosed Then rot.Close
  Set rot = Nothing
  Set connOnLine = Nothing
  exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", PRAZO DE PRODUÇÃO CALCULADO...")
fim_erro:
  DoCmd.Hourglass False
Exit Sub

deleta_gerados:
  
  sql = " delete                    " _
      & "   from ethos_edi_opeprazo " _
      & "  where cod_empresa    = '" & selemp & "' " _
      & "    and cod_item_princ = '" & pai_princ & "'" _
      & "    and num_pedido     = " & vnum_pedido & " " _
      & "    and num_seq_pedido = " & vseq_pedido & " " _
      & "    and num_ordem      = " & vnum_ordem & " "

  If (prz.State) <> adStateClosed Then prz.Close
  
  telacorr = DoEvents
  prz.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
  telacorr = DoEvents
  
  sql = " delete                " _
      & "   from ethos_edi_opepratm " _
      & "  where cod_empresa    = '" & selemp & "' " _
      & "    and cod_item_princ = '" & pai_princ & "'" _
      & "    and num_pedido     = " & vnum_pedido & " " _
      & "    and num_seq_pedido = " & vseq_pedido & " " _
      & "    and num_ordem      = " & vnum_ordem & " "

  If (prz.State) <> adStateClosed Then prz.Close
  
  telacorr = DoEvents
  prz.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
  telacorr = DoEvents

Return



tratar_nivel_1:
  nv_pai = pai
  sql = "select *                    " _
      & "  from estrutura            " _
      & " where cod_empresa  = '" & selemp & "' " _
      & "   and cod_item_pai = '" & nv_pai & "' "

  If (fl1.State) <> adStateClosed Then fl1.Close
      
  telacorr = DoEvents
  fl1.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  NIVEL_COMPON = "01"
  cod_compon = nulo
  pai_acima = nulo
  
  Do While Not fl1.EOF
     NIVEL_COMPON = "01"
     pai = Trim(fl1.Fields("cod_item_compon"))
     cod_compon = Trim(fl1.Fields("cod_item_compon"))
     pai_acima = Trim(fl1.Fields("cod_item_pai"))
     exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", LENDO ESTRUTURA, ITEM PAI ... " & pai_princ & ", ITEM FILHO ... " & pai)
     GoSub busca_operacoes
     GoSub tratar_nivel_2
     fl1.MoveNext
     If fl1.EOF Then Exit Do
  Loop

Return

tratar_nivel_2:
  nv_pai = pai
  sql = "select *                    " _
      & "  from estrutura            " _
      & " where cod_empresa  = '" & selemp & "' " _
      & "   and cod_item_pai = '" & nv_pai & "' "

  If (fl2.State) <> adStateClosed Then fl2.Close
      
  telacorr = DoEvents
  fl2.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  NIVEL_COMPON = "02"
  cod_compon = nulo
  pai_acima = nulo
  
  Do While Not fl2.EOF
     NIVEL_COMPON = "02"
     pai = Trim(fl2.Fields("cod_item_compon"))
     cod_compon = Trim(fl2.Fields("cod_item_compon"))
     pai_acima = Trim(fl2.Fields("cod_item_pai"))
     exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", LENDO ESTRUTURA, ITEM PAI ... " & pai_princ & ", ITEM FILHO ... " & pai)
     GoSub busca_operacoes
     GoSub tratar_nivel_3
     fl2.MoveNext
     If fl2.EOF Then Exit Do
  Loop

Return

tratar_nivel_3:
  nv_pai = pai
  sql = "select *                    " _
      & "  from estrutura            " _
      & " where cod_empresa  = '" & selemp & "' " _
      & "   and cod_item_pai = '" & nv_pai & "' "

  If (fl3.State) <> adStateClosed Then fl3.Close
      
  telacorr = DoEvents
  fl3.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  NIVEL_COMPON = "03"
  cod_compon = nulo
  pai_acima = nulo
  
  Do While Not fl3.EOF
     NIVEL_COMPON = "03"
     pai = Trim(fl3.Fields("cod_item_compon"))
     cod_compon = Trim(fl3.Fields("cod_item_compon"))
     pai_acima = Trim(fl3.Fields("cod_item_pai"))
     exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", LENDO ESTRUTURA, ITEM PAI ... " & pai_princ & ", ITEM FILHO ... " & pai)
     GoSub busca_operacoes
     GoSub tratar_nivel_4
     fl3.MoveNext
     If fl3.EOF Then Exit Do
  Loop

Return

tratar_nivel_4:
  nv_pai = pai
  sql = "select *                    " _
      & "  from estrutura            " _
      & " where cod_empresa  = '" & selemp & "' " _
      & "   and cod_item_pai = '" & nv_pai & "' "

  If (fl4.State) <> adStateClosed Then fl4.Close
      
  telacorr = DoEvents
  fl4.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  NIVEL_COMPON = "04"
  cod_compon = nulo
  pai_acima = nulo
  
  Do While Not fl4.EOF
     NIVEL_COMPON = "04"
     pai = Trim(fl4.Fields("cod_item_compon"))
     cod_compon = Trim(fl4.Fields("cod_item_compon"))
     pai_acima = Trim(fl4.Fields("cod_item_pai"))
     exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", LENDO ESTRUTURA, ITEM PAI ... " & pai_princ & ", ITEM FILHO ... " & pai)
     GoSub busca_operacoes
     GoSub tratar_nivel_5
     fl4.MoveNext
     If fl4.EOF Then Exit Do
  Loop

Return

tratar_nivel_5:
  nv_pai = pai
  sql = "select *                    " _
      & "  from estrutura            " _
      & " where cod_empresa  = '" & selemp & "' " _
      & "   and cod_item_pai = '" & nv_pai & "' "

  If (fl5.State) <> adStateClosed Then fl5.Close
      
  telacorr = DoEvents
  fl5.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  NIVEL_COMPON = "05"
  cod_compon = nulo
  pai_acima = nulo
  
  Do While Not fl5.EOF
     NIVEL_COMPON = "05"
     pai = Trim(fl5.Fields("cod_item_compon"))
     cod_compon = Trim(fl5.Fields("cod_item_compon"))
     pai_acima = Trim(fl5.Fields("cod_item_pai"))
     exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", LENDO ESTRUTURA, ITEM PAI ... " & pai_princ & ", ITEM FILHO ... " & pai)
     GoSub busca_operacoes
     GoSub tratar_nivel_6
     fl5.MoveNext
     If fl5.EOF Then Exit Do
  Loop

Return

tratar_nivel_6:
  nv_pai = pai
  sql = "select *                    " _
      & "  from estrutura            " _
      & " where cod_empresa  = '" & selemp & "' " _
      & "   and cod_item_pai = '" & nv_pai & "' "

  If (fl6.State) <> adStateClosed Then fl6.Close
      
  telacorr = DoEvents
  fl6.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  NIVEL_COMPON = "06"
  cod_compon = nulo
  pai_acima = nulo
  
  Do While Not fl6.EOF
     NIVEL_COMPON = "06"
     pai = Trim(fl6.Fields("cod_item_compon"))
     cod_compon = Trim(fl6.Fields("cod_item_compon"))
     pai_acima = Trim(fl6.Fields("cod_item_pai"))
     exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", LENDO ESTRUTURA, ITEM PAI ... " & pai_princ & ", ITEM FILHO ... " & pai)
     GoSub busca_operacoes
     GoSub tratar_nivel_7
     fl6.MoveNext
     If fl6.EOF Then Exit Do
  Loop

Return

tratar_nivel_7:
  nv_pai = pai
  sql = "select *                    " _
      & "  from estrutura            " _
      & " where cod_empresa  = '" & selemp & "' " _
      & "   and cod_item_pai = '" & nv_pai & "' "

  If (fl7.State) <> adStateClosed Then fl7.Close
      
  telacorr = DoEvents
  fl7.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  NIVEL_COMPON = "07"
  cod_compon = nulo
  pai_acima = nulo
  
  Do While Not fl7.EOF
     NIVEL_COMPON = "07"
     pai = Trim(fl7.Fields("cod_item_compon"))
     cod_compon = Trim(fl7.Fields("cod_item_compon"))
     pai_acima = Trim(fl7.Fields("cod_item_pai"))
     exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", LENDO ESTRUTURA, ITEM PAI ... " & pai_princ & ", ITEM FILHO ... " & pai)
     GoSub busca_operacoes
     GoSub tratar_nivel_8
     fl7.MoveNext
     If fl7.EOF Then Exit Do
  Loop

Return

tratar_nivel_8:
  nv_pai = pai
  sql = "select *                    " _
      & "  from estrutura            " _
      & " where cod_empresa  = '" & selemp & "' " _
      & "   and cod_item_pai = '" & nv_pai & "' "

  If (fl8.State) <> adStateClosed Then fl8.Close
      
  telacorr = DoEvents
  fl8.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  NIVEL_COMPON = "08"
  cod_compon = nulo
  pai_acima = nulo
  
  Do While Not fl8.EOF
     NIVEL_COMPON = "08"
     pai = Trim(fl8.Fields("cod_item_compon"))
     cod_compon = Trim(fl8.Fields("cod_item_compon"))
     pai_acima = Trim(fl8.Fields("cod_item_pai"))
     exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", LENDO ESTRUTURA, ITEM PAI ... " & pai_princ & ", ITEM FILHO ... " & pai)
     GoSub busca_operacoes
     GoSub tratar_nivel_9
     fl8.MoveNext
     If fl8.EOF Then Exit Do
  Loop

Return


tratar_nivel_9:
  nv_pai = pai
  sql = "select *                    " _
      & "  from estrutura            " _
      & " where cod_empresa  = '" & selemp & "' " _
      & "   and cod_item_pai = '" & nv_pai & "' "

  If (fl9.State) <> adStateClosed Then fl9.Close
      
  telacorr = DoEvents
  fl9.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  NIVEL_COMPON = "09"
  cod_compon = nulo
  pai_acima = nulo
  
  Do While Not fl9.EOF
     NIVEL_COMPON = "09"
     pai = Trim(fl9.Fields("cod_item_compon"))
     cod_compon = Trim(fl9.Fields("cod_item_compon"))
     pai_acima = Trim(fl9.Fields("cod_item_pai"))
     exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", LENDO ESTRUTURA, ITEM PAI ... " & pai_princ & ", ITEM FILHO ... " & pai)
     GoSub busca_operacoes
     GoSub tratar_nivel_10
     fl9.MoveNext
     If fl9.EOF Then Exit Do
  Loop

Return


tratar_nivel_10:
  nv_pai = pai
  sql = "select *                    " _
      & "  from estrutura            " _
      & " where cod_empresa  = '" & selemp & "' " _
      & "   and cod_item_pai = '" & nv_pai & "' "

  If (fl10.State) <> adStateClosed Then fl10.Close
      
  telacorr = DoEvents
  fl10.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  NIVEL_COMPON = "10"
  cod_compon = nulo
  pai_acima = nulo
  
  Do While Not fl10.EOF
     NIVEL_COMPON = "10"
     pai = Trim(fl10.Fields("cod_item_compon"))
     cod_compon = Trim(fl10.Fields("cod_item_compon"))
     pai_acima = Trim(fl10.Fields("cod_item_pai"))
     exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", LENDO ESTRUTURA, ITEM PAI ... " & pai_princ & ", ITEM FILHO ... " & pai)
     GoSub busca_operacoes
     GoSub tratar_nivel_11
     fl10.MoveNext
     If fl10.EOF Then Exit Do
  Loop

Return


tratar_nivel_11:
  nv_pai = pai
  sql = "select *                    " _
      & "  from estrutura            " _
      & " where cod_empresa  = '" & selemp & "' " _
      & "   and cod_item_pai = '" & nv_pai & "' "

  If (fl11.State) <> adStateClosed Then fl11.Close
      
  telacorr = DoEvents
  fl11.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  NIVEL_COMPON = "11"
  cod_compon = nulo
  pai_acima = nulo
  
  Do While Not fl11.EOF
     NIVEL_COMPON = "11"
     pai = Trim(fl11.Fields("cod_item_compon"))
     cod_compon = Trim(fl11.Fields("cod_item_compon"))
     pai_acima = Trim(fl11.Fields("cod_item_pai"))
     exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", LENDO ESTRUTURA, ITEM PAI ... " & pai_princ & ", ITEM FILHO ... " & pai)
     GoSub busca_operacoes
     GoSub tratar_nivel_12
     fl11.MoveNext
     If fl11.EOF Then Exit Do
  Loop

Return



tratar_nivel_12:
  nv_pai = pai
  sql = "select *                    " _
      & "  from estrutura            " _
      & " where cod_empresa  = '" & selemp & "' " _
      & "   and cod_item_pai = '" & nv_pai & "' "

  If (fl12.State) <> adStateClosed Then fl12.Close
      
  telacorr = DoEvents
  fl12.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  NIVEL_COMPON = "12"
  cod_compon = nulo
  pai_acima = nulo
  
  Do While Not fl12.EOF
     NIVEL_COMPON = "12"
     pai = Trim(fl12.Fields("cod_item_compon"))
     cod_compon = Trim(fl12.Fields("cod_item_compon"))
     pai_acima = Trim(fl12.Fields("cod_item_pai"))
     exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", LENDO ESTRUTURA, ITEM PAI ... " & pai_princ & ", ITEM FILHO ... " & pai)
     GoSub busca_operacoes
'     GoSub tratar_nivel_13
     fl12.MoveNext
     If fl12.EOF Then Exit Do
  Loop

Return


busca_operacoes:
  nv_pai = pai
  
  sql = "set isolation to dirty read "
  If (rot.State) <> adStateClosed Then rot.Close
      
  telacorr = DoEvents
  rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  sql = "select     *   " _
      & " from item     " _
      & " where cod_empresa        = '" & selemp & "' " _
      & "   and cod_item           = '" & Trim(nv_pai) & "' " _
      & "   and ies_tip_item in('F','P') "
  
  telacorr = DoEvents
  rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  If rot.EOF Then Return
  
  
  sql = "set isolation to dirty read "
  If (rot.State) <> adStateClosed Then rot.Close
      
  telacorr = DoEvents
  rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  sql = "select     *   " _
      & " from item_man " _
      & " where cod_empresa        = '" & selemp & "' " _
      & "   and cod_item           = '" & Trim(nv_pai) & "' "
  
  telacorr = DoEvents
  rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents

  If rot.EOF Then Return
  
  codigo_roteiro = Trim(rot.Fields("cod_roteiro"))
  altern_roteiro = rot.Fields("num_altern_roteiro")
  
  
  sql = "set isolation to dirty read "
  If (con.State) <> adStateClosed Then con.Close
      
  telacorr = DoEvents
  con.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  sql = "select cod_empresa,     " _
      & "       cod_item,        " _
      & "       cod_roteiro,     " _
      & "       num_seq_operac,  " _
      & "       cod_operac,      " _
      & "       parametro        " _
      & "  from consumo " _
      & " where cod_empresa        = '" & selemp & "' " _
      & "   and cod_item           = '" & nv_pai & "' " _
      & "   and trim(cod_roteiro)  = '" & Trim(codigo_roteiro) & "' " _
      & "   and num_altern_roteiro = " & altern_roteiro & " " _
      & " order by 1,2,3,4,5 "
      
  telacorr = DoEvents
  con.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
        
  Do While Not con.EOF
'     MsgBox pai & " ..." & con.Fields("num_seq_operac") & " / " & con.Fields("cod_operac")
     GoSub busca_dias_prazo
     con.MoveNext
     If con.EOF Then Exit Do
  Loop

Return

busca_dias_prazo:
  
  nordem = vnum_ordem
  
  sql = "select *                   " _
      & "  from info_tecnicas       " _
      & " where cod_empresa      = '" & selemp & "' " _
      & "   and cod_compon       = '" & nv_pai & "' " _
      & "   and cod_pdr_info_tec = " & param_tmp_seq & " " _
      & "   and num_seq          = " & Val(con.Fields("cod_operac"))

  If (ope.State) <> adStateClosed Then ope.Close
      
  telacorr = DoEvents
  ope.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
      
  If ope.EOF Then
     sql = "select *                   " _
         & "  from info_tecnicas       " _
         & " where cod_empresa      = '" & selemp & "' " _
         & "   and cod_compon       = '" & param_tempos & "' " _
         & "   and cod_pdr_info_tec = " & param_tmp_seq & " " _
         & "   and num_seq          = " & Val(con.Fields("cod_operac"))
         
         If (ope.State) <> adStateClosed Then ope.Close
      
         telacorr = DoEvents
         ope.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
         telacorr = DoEvents
         If ope.EOF Then Return
  End If
         
  If (IsNull(ope.Fields("des_inf_tecnica"))) Then prazo_dias = 0
       
  prazo_dias = Val(ope.Fields("des_inf_tecnica"))
       
  If (IsNull(prazo_dias)) Then prazo_dias = 0
  
  sql = "select *       " _
      & " from operacao " _
      & "where cod_empresa = '" & selemp & "' " _
      & "  and cod_operac  = '" & con.Fields("cod_operac") & "' "
      
  If (ope.State) <> adStateClosed Then ope.Close
      
  telacorr = DoEvents
  ope.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  If ope.EOF Then Return
  
'  MsgBox Trim(ope.Fields("den_operac")) & " dias execucao: " & prazo_dias
      
  sql = " select *              " _
      & "   from ethos_edi_opeprazo " _
      & "  where cod_empresa = '" & selemp & "' " _
      & "    and cod_item_princ = 'X'"
      
  If (prz.State) <> adStateClosed Then prz.Close
  
  telacorr = DoEvents
  prz.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
  telacorr = DoEvents
'aqui
  If prz.EOF Then
     prz.AddNew
     prz.Fields("cod_empresa") = selemp
     prz.Fields("cod_item_princ") = pai_princ
     prz.Fields("num_pedido") = vnum_pedido
     prz.Fields("num_seq_pedido") = vseq_pedido
     prz.Fields("num_ordem") = vnum_ordem
     prz.Fields("dat_entrega_princ") = vdat_entrega_princ
     prz.Fields("num_ordem_filho") = nordem
     prz.Fields("cod_item") = pai_acima
     prz.Fields("nivel_compon_ori") = NIVEL_COMPON
     prz.Fields("nivel_componente") = NIVEL_COMPON
     prz.Fields("cod_componente") = cod_compon
     
     verifica_item = cod_compon Like "*-110-*"
     
     If verifica_item = True Then
        prz.Fields("nivel_componente") = "01"
     End If
     
     If verifica_item = False And NIVEL_COMPON <> "00" Then
        prz.Fields("nivel_componente") = "02"
     End If
     
     prz.Fields("num_seq_operac") = con.Fields("num_seq_operac")
     prz.Fields("cod_operac") = con.Fields("cod_operac")
     prz.Fields("den_operac") = Trim(ope.Fields("den_operac"))
     prz.Fields("parametro") = con.Fields("parametro")
     prz.Fields("dias_execucao") = prazo_dias
     prz.Update
  End If
      
Return

definir_datas:
   
  sql = "   select nivel_componente " _
      & "    from ethos_edi_opeprazo    " _
      & "   where cod_empresa = '" & selemp & "' " _
      & "    and cod_item_princ   = '" & pai_princ & "' " _
      & "    and num_pedido       = " & vnum_pedido & " " _
      & "    and num_seq_pedido   = " & vseq_pedido & " " _
      & "    and num_ordem        = " & vnum_ordem & " " _
      & "    and cod_componente like '%-110-%'         " _
      & "    and cod_operac      <> 'XXXXX'            " _
      & "  group by 1                                  " _
      & "  order by 1                                  "
   
   If (rot.State) <> adStateClosed Then rot.Close
      
   telacorr = DoEvents
   rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents
   
   nivel_comparar = "'00'"
   Do While Not rot.EOF
      nivel_comparar = nivel_comparar & ", '" & Trim(rot.Fields("nivel_componente")) & "'"
      rot.MoveNext
      If rot.EOF Then Exit Do
   Loop
   
   nivel_comparar = Trim(nivel_comparar)

  'encontrar dias necessários para execução das operações do item_principal
   sql = " select num_seq_operac,                      " _
       & "            cod_operac,                      " _
       & "            dias_execucao                    " _
       & "   from ethos_edi_opeprazo                   " _
       & "  where cod_empresa      = '" & selemp & "' " _
       & "    and cod_item_princ   = '" & pai_princ & "' " _
       & "    and num_pedido       = " & vnum_pedido & " " _
       & "    and num_seq_pedido   = " & vseq_pedido & " " _
       & "    and num_ordem        = " & vnum_ordem & " " _
       & "    and nivel_componente in (" & nivel_comparar & ") " _
       & "    and cod_operac      <> 'XXXXX' " _
       & "  group by 1,2,3                   " _
       & "  order by 1,2                     "

   If (ddt.State) <> adStateClosed Then ddt.Close
      
   telacorr = DoEvents
   ddt.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents

   dias_princi = 0
   nr_oper_pri = 1
   Do While Not ddt.EOF
      dias_princi = dias_princi + ddt.Fields("dias_execucao")
      ddt.MoveNext
      If ddt.EOF Then Exit Do
      nr_oper_pri = nr_oper_pri + 1
   Loop
   
'   MsgBox "dias para calcular as datas do nivel principal: " & dias_princi
   
  'encontrar dias necessários para execução das operações dos outros itens
   sql = " select     '1' num_seq_operac,              " _
       & "            cod_operac,                      " _
       & "            dias_execucao                    " _
       & "   from ethos_edi_opeprazo                   " _
       & "  where cod_empresa       = '" & selemp & "' " _
       & "    and cod_item_princ    = '" & pai_princ & "' " _
       & "    and num_pedido        = " & vnum_pedido & " " _
       & "    and num_seq_pedido    = " & vseq_pedido & " " _
       & "    and num_ordem         = " & vnum_ordem & " " _
       & "    and nivel_componente not in (" & nivel_comparar & ") " _
       & "    and cod_operac       <> 'XXXXX' " _
       & "  group by 1,2,3                    " _
       & "  order by 1,2                      "

   If (ddt.State) <> adStateClosed Then ddt.Close
      
   telacorr = DoEvents
   ddt.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents
   
   If ddt.EOF Then
      dias_princi = dias_princi + 1
   End If
   
   dias_outros = 0
   nr_oper_out = 1
   Do While Not ddt.EOF
      dias_outros = dias_outros + ddt.Fields("dias_execucao")
      ddt.MoveNext
      If ddt.EOF Then Exit Do
      nr_oper_out = nr_oper_out + 1
   Loop
   
'   MsgBox "dias para calcular as datas do nivel principal: " & dias_outros
   
'aqui novo virtual
   
   sql = "delete from ethos_edi_seq_virt_pri " _
       & "  where cod_empresa       = '" & selemp & "' " _
       & "    and num_pedido        = " & vnum_pedido & " " _
       & "    and num_seq_pedido    = " & vseq_pedido & " " _
       & "    and num_ordem         = " & vnum_ordem & " "
       
   If (tmp.State) <> adStateClosed Then tmp.Close
      
   telacorr = DoEvents
   tmp.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
   telacorr = DoEvents
   
   sql = "  select nivel_componente, " _
       & "         num_seq_operac,   " _
       & "         cod_operac,       " _
       & "         dias_execucao     " _
       & "    from ethos_edi_opeprazo    " _
       & "   where cod_empresa        = '" & selemp & "' " _
       & "     and cod_operac         <> 'XXXXX'    " _
       & "     and nivel_componente   in (" & nivel_comparar & ") " _
       & "     and num_pedido           = " & vnum_pedido & " " _
       & "     and num_seq_pedido       = " & vseq_pedido & " " _
       & "     and num_ordem            = " & vnum_ordem & " " _
       & "   group by 1,2,3,4             " _
       & "   order by 1 desc              " _
     
   If (tmp.State) <> adStateClosed Then tmp.Close
      
   telacorr = DoEvents
   tmp.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
   telacorr = DoEvents
   
   seq_virtual = 50
   old_nivel = "BB"
   Do While Not tmp.EOF
   
      If old_nivel <> tmp.Fields("nivel_componente") Then
         old_nivel = tmp.Fields("nivel_componente")
      End If
      
      sql = "select * from ethos_edi_seq_virt_pri " _
          & "  where cod_empresa       = 'XX'"
      If (prz.State) <> adStateClosed Then prz.Close
     
      telacorr = DoEvents
      prz.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
      telacorr = DoEvents
      If prz.EOF Then
         prz.AddNew
         prz.Fields("cod_empresa") = selemp
         prz.Fields("num_pedido") = vnum_pedido
         prz.Fields("num_seq_pedido") = vseq_pedido
         prz.Fields("num_ordem") = vnum_ordem
         prz.Fields("nivel_componente") = seq_virtual
         prz.Fields("num_seq_operac") = tmp.Fields("num_seq_operac")
         prz.Fields("cod_operac") = tmp.Fields("cod_operac")
         prz.Fields("dias_execucao") = tmp.Fields("dias_execucao")
         prz.Update
      End If
      
      tmp.MoveNext
      If tmp.EOF Then Exit Do
      If old_nivel <> tmp.Fields("nivel_componente") Then
         old_nivel = tmp.Fields("nivel_componente")
         seq_virtual = seq_virtual + 1
      End If
   Loop
   
  'datar as operações do item_principal - incluir data prazo_operacao
   
   sql = " select     nivel_componente,   " _
       & "            num_seq_operac,     " _
       & "            cod_operac,         " _
       & "            dias_execucao       " _
       & "   from ethos_edi_seq_virt_pri      " _
       & "  where cod_empresa      = '" & selemp & "' " _
       & "    and num_pedido       = " & vnum_pedido & " " _
       & "    and num_seq_pedido   = " & vseq_pedido & " " _
       & "    and num_ordem        = " & vnum_ordem & " " _
       & "  order by 1,2             "

   If (ddt.State) <> adStateClosed Then ddt.Close
      
   telacorr = DoEvents
   ddt.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents
   
   total_dias = dias_princi + dias_outros

   
 '  MsgBox "dias operac_pri: " & dias_princi & " / dias_operac_outros: " & dias_outros & " / total de operac pri e outros: " & total_dias & " / qtde_operac_pri: " & nr_oper_pri & " / qtde_operac_outros: " & nr_oper_out
   
   dta_encontrada = CVDate(vdat_entrega_princ) - dias_princi
   
 '  MsgBox "data encontrada: " & dta_encontrada
      
   dta_encontrada_ant = dta_encontrada
   dias_somar_naoutil = 0
   interv_dias = 0
   Do While (interv_dias - dias_somar_naoutil) < dias_princi
      dias_somar_naoutil = 0
      dta_enc_util = "N"
      dias_nao_cons = 0
      Do While dta_enc_util = "N"
         GoSub valida_dias_naoutil
         If dias_somar_naoutil = 0 Then Exit Do
         If dias_somar_naoutil = 1 Then
            dta_encontrada = CVDate(dta_encontrada) - 1
            dias_somar_naoutil = 0
            dias_nao_cons = dias_nao_cons + 1
         End If
      Loop
   
      dta_encontrada_ant = dta_encontrada
   
      interv_dias = CVDate(vdat_entrega_princ) - CVDate(dta_encontrada)
   
      dta_analise = dta_encontrada
   
      dias_somar_naoutil = 0
      Do While Format(dta_analise, "yyyy/mm/dd") <> Format(vdat_entrega_princ, "yyyy/mm/dd")
         dta_encontrada = dta_analise
         GoSub valida_dias_naoutil
         dta_analise = CVDate(dta_analise) + 1
      Loop
   
      If (interv_dias - dias_somar_naoutil) < dias_princi Then dta_encontrada = CVDate(dta_encontrada_ant) - 1
   
   Loop
   
   dta_encontrada = CVDate(dta_encontrada_ant)
   
   
   vnivel_componente = "00"
   passou_aprimira_oper = "N"
   
   Do While Not ddt.EOF
      dad = 1
      deve_gravar = "N"
      Do While dad <= ddt.Fields("dias_execucao")
          exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", AGUARDE, TRATANDO DATAS DE ENTREGAS DAS OPERAÇÕES ... SEQUENCIA: " & ddt.Fields("num_seq_operac") & " OPERAÇÃO: " & ddt.Fields("cod_operac"))
'          MsgBox "olha o dad " & dad
'          MsgBox "data para iniciar: " & dta_encontrada & " atual para operação: " & ddt.Fields("cod_operac")
          If dad = ddt.Fields("dias_execucao") Then deve_gravar = "S"
          GoSub calc_data_princ
'          MsgBox "considerou " & considera_data & " o dad atual eh: " & dad & " dias execução: " & ddt.Fields("dias_execucao")
          dta_encontrada = CVDate(dta_encontrada + 1)
          dad = dad + 1
          If dad > ddt.Fields("dias_execucao") Then Exit Do
      Loop
      ddt.MoveNext
      If ddt.EOF Then Exit Do
   Loop
   
   
 'aqui
   sql = "delete from ethos_edi_seq_virtual " _
       & "  where cod_empresa       = '" & selemp & "' " _
       & "    and num_pedido        = " & vnum_pedido & " " _
       & "    and num_seq_pedido    = " & vseq_pedido & " " _
       & "    and num_ordem         = " & vnum_ordem & " "
       
   If (tmp.State) <> adStateClosed Then tmp.Close
      
   telacorr = DoEvents
   tmp.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
   telacorr = DoEvents
     
   sql = "select    num_seq_operac,    " _
       & "            cod_operac          " _
       & "  from ethos_edi_opeprazo           " _
       & "  where cod_empresa        = '" & selemp & "' " _
       & "    and cod_operac         <> 'XXXXX'    " _
       & "    and nivel_componente not in (" & nivel_comparar & ") " _
       & "    and num_pedido        = " & vnum_pedido & " " _
       & "    and num_seq_pedido    = " & vseq_pedido & " " _
       & "    and num_ordem         = " & vnum_ordem & " " _
       & "  group by 1,2    " _
       & "   order by 1     "
     
   If (tmp.State) <> adStateClosed Then tmp.Close
      
   telacorr = DoEvents
   tmp.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
   telacorr = DoEvents
     
   seq_virtual = 1
   Do While Not tmp.EOF
      sql = "select * from ethos_edi_seq_virtual " _
          & "  where cod_empresa       = '" & selemp & "' " _
          & "    and num_pedido        = " & vnum_pedido & " " _
          & "    and num_seq_pedido    = " & vseq_pedido & " " _
          & "    and num_ordem         = " & vnum_ordem & " " _
          & "    and cod_operac        = '" & tmp.Fields("cod_operac") & "' "

     If (prz.State) <> adStateClosed Then prz.Close
      
     telacorr = DoEvents
     prz.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
     telacorr = DoEvents
     If prz.EOF Then
        prz.AddNew
        prz.Fields("cod_empresa") = selemp
        prz.Fields("num_pedido") = vnum_pedido
        prz.Fields("num_seq_pedido") = vseq_pedido
        prz.Fields("num_ordem") = vnum_ordem
        prz.Fields("num_seq_operac") = seq_virtual
        prz.Fields("cod_operac") = tmp.Fields("cod_operac")
        prz.Update
     Else
        prz.Fields("num_seq_operac") = seq_virtual
        prz.Update
     End If
     tmp.MoveNext
     If tmp.EOF Then Exit Do
     seq_virtual = seq_virtual + 1
   Loop
   
'aqui
  'datar as operações dos outros itens - incluir data prazo_operacao
   
   sql = " select   b.num_seq_operac, " _
       & "          a.cod_operac,             " _
       & "          a.dias_execucao           " _
       & "   from ethos_edi_opeprazo    a,      " _
       & "        ethos_edi_seq_virtual b       " _
       & "  where a.cod_empresa       = '" & selemp & "' " _
       & "    and a.cod_item_princ    = '" & pai_princ & "' " _
       & "    and a.num_pedido        = " & vnum_pedido & " " _
       & "    and a.num_seq_pedido    = " & vseq_pedido & " " _
       & "    and a.num_ordem         = " & vnum_ordem & " " _
       & "    and nivel_componente not in (" & nivel_comparar & ") " _
       & "    and a.cod_operac       <> 'XXXXX'            " _
       & "    and a.cod_empresa       = b.cod_empresa      " _
       & "    and a.num_pedido        = b.num_pedido       " _
       & "    and a.num_seq_pedido    = b.num_seq_pedido   " _
       & "    and a.num_ordem         = b.num_ordem        " _
       & "    and trim(a.cod_operac)  = trim(b.cod_operac) " _
       & "  group by 1,2,3                 " _
       & "  order by 1,2                   "

   If (ddt.State) <> adStateClosed Then ddt.Close
      
   telacorr = DoEvents
   ddt.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents
   
   total_dias = dias_princi + dias_outros
   
'   MsgBox "dias operac_pri: " & dias_princi & " / dias_operac_outros: " & dias_outros & " / total de operac pri e outros: " & total_dias & " / qtde_operac_pri: " & nr_oper_pri & " / qtde_operac_outros: " & nr_oper_out

'   MsgBox "data primeira operacao: " & data_prim_oper
   
   dta_encontrada = CVDate(data_prim_oper) - dias_outros
   
'   MsgBox "data calculada primeira operacao - dias outros: " & dta_encontrada
   
   dta_encontrada_ant = dta_encontrada
   dias_somar_naoutil = 0
   interv_dias = 0
   Do While (interv_dias - dias_somar_naoutil) < dias_outros
      dias_somar_naoutil = 0
      dta_enc_util = "N"
      dias_nao_cons = 0
      Do While dta_enc_util = "N"
         GoSub valida_dias_naoutil
         If dias_somar_naoutil = 0 Then Exit Do
         If dias_somar_naoutil = 1 Then
            dta_encontrada = CVDate(dta_encontrada) - 1
            dias_somar_naoutil = 0
            dias_nao_cons = dias_nao_cons + 1
         End If
      Loop
   
      dta_encontrada_ant = dta_encontrada
   
      interv_dias = CVDate(data_prim_oper) - CVDate(dta_encontrada)
   
      dta_analise = dta_encontrada
   
      dias_somar_naoutil = 0
      Do While Format(dta_analise, "yyyy/mm/dd") <> Format(data_prim_oper, "yyyy/mm/dd")
         dta_encontrada = dta_analise
         GoSub valida_dias_naoutil
         dta_analise = CVDate(dta_analise) + 1
      Loop
   
      If (interv_dias - dias_somar_naoutil) < dias_outros Then dta_encontrada = CVDate(dta_encontrada_ant) - 1
   
   Loop
   
   dta_encontrada = CVDate(dta_encontrada_ant)
   
   
   passou_aprimira_oper = "N"
   vnivel_componente = "XX"
   
   
   Do While Not ddt.EOF
      dad = 1
      deve_gravar = "N"
      Do While dad <= ddt.Fields("dias_execucao")
           exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", AGUARDE, TRATANDO DATAS DE ENTREGAS DAS OPERAÇÕES ... SEQUENCIA: " & ddt.Fields("num_seq_operac") & " OPERAÇÃO: " & ddt.Fields("cod_operac"))
'          MsgBox "olha o dad " & dad
'          MsgBox "data para iniciar: " & dta_encontrada & " atual para operação: " & ddt.Fields("cod_operac")
          If dad = ddt.Fields("dias_execucao") Then deve_gravar = "S"
          GoSub calc_data_princ
'          MsgBox "considerou " & considera_data & " o dad atual eh: " & dad & " dias execução: " & ddt.Fields("dias_execucao")
          dta_encontrada = CVDate(dta_encontrada + 1)
          dad = dad + 1
          If dad > ddt.Fields("dias_execucao") Then Exit Do
      Loop
      ddt.MoveNext
      If ddt.EOF Then Exit Do
   Loop
   
   
Return

calc_data_princ:
   
   sair_loop = "N"
   Do While sair_loop = "N"
      
      exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", AGUARDE, VERIFICANDO SE A DATA DE ENTREGA DA OPERAÇÃO É DIA ÚTIL... SEQUENCIA: " & ddt.Fields("num_seq_operac") & " OPERAÇÃO: " & ddt.Fields("cod_operac"))
      considera_data = "S"
      
      Call encontra_nro_semana
       
      sql = "select *                   " _
          & "  from semana_sup          " _
          & " where cod_empresa = '" & selemp & "' " _
          & "   and ies_dia_semana = " & nro_semana
   
      If (bdt.State) <> adStateClosed Then bdt.Close
 
      bdt.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   
      If Not bdt.EOF Then
         If Not (IsNull(bdt.Fields("ies_situa"))) Then
            If bdt.Fields("ies_situa") = "3" Then considera_data = "N"
         End If
      End If
      
'      MsgBox Format(dta_encontrada, "dd/mm/yyyy") & " -  vai considerar: " & considera_data
      
      If considera_data = "S" Then
         sql = "select *                  " _
             & "  from ethosm_fer_prz     " _
             & " where cod_empresa = '" & selemp & "' " _
             & "   and dat_ref = '" & Format(dta_encontrada, "dd/mm/yyyy") & "' "
           
         If (bdt.State) <> adStateClosed Then bdt.Close
  
         bdt.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
                  
         If Not bdt.EOF Then considera_data = "N"
      End If
      
      If considera_data = "S" Then
'         MsgBox "data " & dta_encontrada & " a ser gravada na operação ... " & ddt.Fields("cod_operac")
         If deve_gravar = "S" Then GoSub gravar_prazo_operacao
         If passou_aprimira_oper = "N" Then data_prim_oper = dta_encontrada
         passou_aprimira_oper = "S"
         sair_loop = "S"
         Exit Do
      End If
      If sair_loop = "S" Then Exit Do
      If passou_aprimira_oper = "N" Then
         dta_encontrada = CVDate(dta_encontrada) - 1
      Else
         dta_encontrada = CVDate(dta_encontrada) + 1
      End If
'      MsgBox "nova data a ser testada: " & dta_encontrada & " para operação " & ddt.Fields("cod_operac")
      exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", AGUARDE, BUSCANDO DIA ÚTIL PARA DATA DE ENTREGA DA OPERAÇÃO ... SEQUENCIA: " & ddt.Fields("num_seq_operac") & " OPERAÇÃO: " & ddt.Fields("cod_operac"))
   Loop

Return

gravar_prazo_operacao:
'AQUIaqui
   
   verifica_nivel = nivel_comparar Like "*" & vnivel_componente & "*"
   
   If verifica_nivel = True Then
      sql = " select  '1' num_seq_operac,     " _
          & "             cod_operac          " _
          & "   from ethos_edi_opeprazo          " _
          & "  where cod_empresa    = '" & selemp & "' " _
          & "    and cod_item_princ = '" & pai_princ & "' " _
          & "    and num_pedido     = " & vnum_pedido & " " _
          & "    and num_seq_pedido = " & vseq_pedido & " " _
          & "    and num_ordem      = " & vnum_ordem & " " _
          & "    and nivel_componente in (" & nivel_comparar & ") " _
          & "    and cod_operac       = '" & Trim(ddt.Fields("cod_operac")) & "' " _
          & "  group by 1,2 " _
          & "  order by 1,2 "

   Else
      sql = " select  '1' num_seq_operac,     " _
          & "             cod_operac          " _
          & "   from ethos_edi_opeprazo          " _
          & "  where cod_empresa    = '" & selemp & "' " _
          & "    and cod_item_princ = '" & pai_princ & "' " _
          & "    and num_pedido     = " & vnum_pedido & " " _
          & "    and num_seq_pedido = " & vseq_pedido & " " _
          & "    and num_ordem      = " & vnum_ordem & " " _
          & "    and nivel_componente not in (" & nivel_comparar & ") " _
          & "    and cod_operac       <> 'XXXXX' " _
          & "    and cod_operac       = '" & Trim(ddt.Fields("cod_operac")) & "' " _
          & "  group by 1,2 " _
          & "  order by 1,2 "
   
  End If
   
   If (gdt.State) <> adStateClosed Then gdt.Close
      
   telacorr = DoEvents
   gdt.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents
   
   
   Do While Not gdt.EOF
   
      exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", AGUARDE, TRATANDO AS DATAS DE ENTREGA DAS OPERAÇÕES ... SEQUENCIA: " & ddt.Fields("num_seq_operac") & " OPERAÇÃO: " & ddt.Fields("cod_operac"))
      sql = " select *                       " _
          & "   from ethos_edi_opepratm          " _
          & "  where cod_empresa      = '" & selemp & "' " _
          & "    and cod_item_princ   = '" & pai_princ & "' " _
          & "    and num_pedido       = " & vnum_pedido & " " _
          & "    and num_seq_pedido   = " & vseq_pedido & " " _
          & "    and num_ordem        = " & vnum_ordem & " " _
          & "    and nivel_componente = '" & vnivel_componente & "' " _
          & "    and cod_operac       = " & gdt.Fields("cod_operac") & " " _
          & "    and prazo_operacao   = '" & Format(dta_encontrada, "dd/mm/yyyy") & "' "
       

       If (tmp.State) <> adStateClosed Then tmp.Close
      
       telacorr = DoEvents
       tmp.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
       telacorr = DoEvents
'       MsgBox "vou gravar operacao: " & gdt.Fields("cod_operac")
       If tmp.EOF Then
          tmp.AddNew
          tmp.Fields("cod_empresa") = selemp
          tmp.Fields("cod_item_princ") = pai_princ
          tmp.Fields("num_pedido") = vnum_pedido
          tmp.Fields("num_seq_pedido") = vseq_pedido
          tmp.Fields("num_ordem") = vnum_ordem
          tmp.Fields("nivel_componente") = vnivel_componente
          tmp.Fields("num_seq_operac") = gdt.Fields("num_seq_operac")
          tmp.Fields("cod_operac") = gdt.Fields("cod_operac")
          tmp.Fields("prazo_operacao") = Format(dta_encontrada, "dd/mm/yyyy")
          tmp.Update
       Else
          tmp.Fields("prazo_operacao") = Format(dta_encontrada, "dd/mm/yyyy")
          tmp.Update
       End If
       
       gdt.MoveNext
       
       If gdt.EOF Then Exit Do
   Loop

Return

finaliza:
  exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", AGUARDE, GRAVANDO OS PRAZOS DE ENTREGA DAS OPERAÇÕES... ")
  
  sql = "set isolation to dirty read "
  If (rot.State) <> adStateClosed Then rot.Close
      
  telacorr = DoEvents
  rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  sql = "select cod_empresa,     " _
      & "       cod_item_princ,  " _
      & "       num_pedido,      " _
      & "       num_seq_pedido,  " _
      & "       num_ordem        " _
      & "  from ethos_edi_opeprazo   " _
      & " where cod_empresa    = '" & selemp & "' " _
      & "   and cod_item_princ   = '" & pai_princ & "'" _
      & "   and num_pedido       = " & vnum_pedido & " " _
      & "   and num_seq_pedido   = " & vseq_pedido & " " _
      & "   and num_ordem        = " & vnum_ordem & " " _
      & "   and nivel_componente in (" & nivel_comparar & ") " _
      & "   and cod_operac       <> 'XXXXX' " _
      & "   and dias_execucao    <> 0 " _
      & "   and prazo_operacao  is null " _
      & "  group by 1,2,3,4,5 "
      
  
  telacorr = DoEvents
  rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
      
Do While Not rot.EOF
  
 exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", AGUARDE, GRAVANDO OS PRAZOS...")
  
 tota_atualiz = 0
 qtde_atualiz = 0
 
 
 sql = "set isolation to dirty read"
 
 If (prz.State) <> adStateClosed Then prz.Close
      
 telacorr = DoEvents
 prz.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
 telacorr = DoEvents
 
 sql = "select count(*) tot_atualizar  " _
     & "  from ethos_edi_opeprazo      " _
     & " where cod_empresa       = '" & rot.Fields("cod_empresa") & "' " _
     & "    and cod_item_princ   = '" & Trim(rot.Fields("cod_item_princ")) & "' " _
     & "    and num_pedido       = " & rot.Fields("num_pedido") & " " _
     & "    and num_seq_pedido   = " & rot.Fields("num_seq_pedido") & " " _
     & "    and num_ordem        = " & rot.Fields("num_ordem") & " " _
     & "    and nivel_componente in (" & nivel_comparar & ") " _
     & "    and cod_operac       <> 'XXXXX' " _
     & "    and dias_execucao    <> 0 " _
     & "    and prazo_operacao   is null " _

 telacorr = DoEvents
 prz.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
 telacorr = DoEvents
 
 If Not prz.EOF Then tota_atualiz = prz.Fields("tot_atualizar")
 
 loops = "C"
 Do While loops = "C"
  
  sql = "set isolation to dirty read"
 
  If (prz.State) <> adStateClosed Then prz.Close
      
  telacorr = DoEvents
  prz.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  
  sql = "select *              " _
      & "  from ethos_edi_opepratm " _
      & " where ethos_edi_opepratm.cod_empresa      = '" & rot.Fields("cod_empresa") & "'" _
      & "   and ethos_edi_opepratm.cod_item_princ   = '" & Trim(rot.Fields("cod_item_princ")) & "'" _
      & "   and ethos_edi_opepratm.num_pedido       = " & rot.Fields("num_pedido") & " " _
      & "   and ethos_edi_opepratm.num_seq_pedido   = " & rot.Fields("num_seq_pedido") & " " _
      & "   and ethos_edi_opepratm.num_ordem        = " & rot.Fields("num_ordem") & " " _
      & "   and ethos_edi_opepratm.nivel_componente = '00' "
      
      telacorr = DoEvents
      prz.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
      telacorr = DoEvents
      
      If prz.EOF Then Exit Do
      
      Do While Not prz.EOF
         
         exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", FINALIZANDO - AGUARDE, GRAVANDO OS PRAZOS DA OPERAÇÃO... " & prz.Fields("cod_operac"))
      
         sql = "set isolation to dirty read"
 
         If (tmp.State) <> adStateClosed Then tmp.Close
      
         telacorr = DoEvents
         tmp.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
         telacorr = DoEvents
         
          sql = "select first 1 *, rowid reg_log " _
              & "  from ethos_edi_opeprazo           " _
              & " where cod_empresa       = '" & rot.Fields("cod_empresa") & "' " _
              & "    and cod_item_princ   = '" & Trim(rot.Fields("cod_item_princ")) & "' " _
              & "    and num_pedido       = " & rot.Fields("num_pedido") & " " _
              & "    and num_seq_pedido   = " & rot.Fields("num_seq_pedido") & " " _
              & "    and num_ordem        = " & rot.Fields("num_ordem") & " " _
              & "    and cod_operac       = '" & prz.Fields("cod_operac") & "' " _
              & "    and nivel_componente in (" & nivel_comparar & ") " _
              & "    and dias_execucao    <> 0 " _
              & "    and prazo_operacao   is null " _
              & " order by 9, 7, 8, 10, 11      " _

          telacorr = DoEvents
          tmp.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
          telacorr = DoEvents
          
          If Not tmp.EOF Then
             exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", AGUARDE, GRAVANDO OS PRAZOS DA OPERAÇÃO... " & prz.Fields("cod_operac") & " - " & Format(prz.Fields("prazo_operacao"), "dd/mm/yyyy"))
             sql = "update ethos_edi_opeprazo " _
                 & "   set prazo_operacao   = '" & Format(prz.Fields("prazo_operacao"), "dd/mm/yyyy") & "' " _
                 & " where cod_empresa      = '" & rot.Fields("cod_empresa") & "' " _
                 & "   and rowid            = " & tmp.Fields("reg_log") & " " _
                 & "   and prazo_operacao   is null " _

             If (gut.State) <> adStateClosed Then gut.Close
      
             telacorr = DoEvents
             gut.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
             telacorr = DoEvents
             qtde_atualiz = qtde_atualiz + 1
          End If
      
          prz.MoveNext
          If prz.EOF Then Exit Do
      Loop
      If qtde_atualiz >= tota_atualiz Then loops = "F"
      If loops = "F" Then Exit Do
 Loop
  rot.MoveNext
  If rot.EOF Then Exit Do
Loop
'aqui

Return










finaliza1:
  'aqui
  exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", AGUARDE, GRAVANDO OS PRAZOS DE ENTREGA DAS OPERAÇÕES... ")
  sql = "set isolation to dirty read "
  If (rot.State) <> adStateClosed Then rot.Close
      
  telacorr = DoEvents
  rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  sql = "select cod_empresa,     " _
      & "       cod_item_princ,  " _
      & "       num_pedido,      " _
      & "       num_seq_pedido,  " _
      & "       num_ordem        " _
      & "  from ethos_edi_opeprazo   " _
      & " where cod_empresa    = '" & selemp & "' " _
      & " and cod_operac       <> 'XXXXX' " _
      & " and dias_execucao    <> 0 " _
      & " and prazo_operacao  is null " _
      & "  group by 1,2,3,4,5 " _
      & "  order by 1,5 "
      
  telacorr = DoEvents
  rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
      
Do While Not rot.EOF
  
 exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", AGUARDE, GRAVANDO OS PRAZOS...")
 tota_atualiz = 0
 qtde_atualiz = 0
 
 
 sql = "set isolation to dirty read"
 
 If (prz.State) <> adStateClosed Then prz.Close
      
 telacorr = DoEvents
 prz.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
 telacorr = DoEvents
 
 sql = "select count(*) tot_atualizar  " _
     & "  from ethos_edi_opeprazo      " _
     & " where cod_empresa       = '" & rot.Fields("cod_empresa") & "' " _
     & "    and cod_item_princ   = '" & Trim(rot.Fields("cod_item_princ")) & "' " _
     & "    and num_pedido       = " & rot.Fields("num_pedido") & " " _
     & "    and num_seq_pedido   = " & rot.Fields("num_seq_pedido") & " " _
     & "    and num_ordem        = " & rot.Fields("num_ordem") & " " _
     & "    and cod_operac       <> 'XXXXX' " _
     & "    and dias_execucao    <> 0 " _
     & "    and prazo_operacao   is null " _

 telacorr = DoEvents
 prz.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
 telacorr = DoEvents
 
 If Not prz.EOF Then tota_atualiz = prz.Fields("tot_atualizar")
 
 loops = "C"
 Do While loops = "C"
  
  sql = "set isolation to dirty read"
 
  If (prz.State) <> adStateClosed Then prz.Close
      
  telacorr = DoEvents
  prz.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
  telacorr = DoEvents
  
  
  sql = "select *              " _
      & "  from ethos_edi_opepratm " _
      & " where ethos_edi_opepratm.cod_empresa      = '" & rot.Fields("cod_empresa") & "'" _
      & "   and ethos_edi_opepratm.cod_item_princ   = '" & Trim(rot.Fields("cod_item_princ")) & "'" _
      & "   and ethos_edi_opepratm.num_pedido       = " & rot.Fields("num_pedido") & " " _
      & "   and ethos_edi_opepratm.num_seq_pedido   = " & rot.Fields("num_seq_pedido") & " " _
      & "   and ethos_edi_opepratm.num_ordem        = " & rot.Fields("num_ordem") & " " _
      & "   and ethos_edi_opepratm.nivel_componente = 'XX' "
      
      telacorr = DoEvents
      prz.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
      telacorr = DoEvents
      
      If prz.EOF Then Exit Do
      
      Do While Not prz.EOF
         
         exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", AGUARDE, GRAVANDO OS PRAZOS DA OPERAÇÃO... " & prz.Fields("cod_operac"))
         
         sql = "set isolation to dirty read"
 
         If (tmp.State) <> adStateClosed Then tmp.Close
      
         telacorr = DoEvents
         tmp.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
         telacorr = DoEvents
          
          sql = "select first 1 *, rowid reg_log " _
              & "  from ethos_edi_opeprazo           " _
              & " where cod_empresa       = '" & rot.Fields("cod_empresa") & "' " _
              & "    and cod_item_princ   = '" & Trim(rot.Fields("cod_item_princ")) & "' " _
              & "    and num_pedido       = " & rot.Fields("num_pedido") & " " _
              & "    and num_seq_pedido   = " & rot.Fields("num_seq_pedido") & " " _
              & "    and num_ordem        = " & rot.Fields("num_ordem") & " " _
              & "    and cod_operac       = '" & prz.Fields("cod_operac") & "' " _
              & "    and dias_execucao   <> 0 " _
              & "    and prazo_operacao   is null " _
              & " order by 9, 7, 8, 10, 11      " _

          telacorr = DoEvents
          tmp.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
          telacorr = DoEvents
          
          If Not tmp.EOF Then
             exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", AGUARDE, GRAVANDO OS PRAZOS DA OPERAÇÃO... " & prz.Fields("cod_operac") & " - " & Format(prz.Fields("prazo_operacao"), "dd/mm/yyyy"))
             sql = "update ethos_edi_opeprazo " _
                 & "   set prazo_operacao  = '" & Format(prz.Fields("prazo_operacao"), "dd/mm/yyyy") & "' " _
                 & " where cod_empresa = '" & rot.Fields("cod_empresa") & "' " _
                 & "   and rowid       = " & tmp.Fields("reg_log")
                  
             If (gut.State) <> adStateClosed Then gut.Close
      
             telacorr = DoEvents
             gut.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
             telacorr = DoEvents
             qtde_atualiz = qtde_atualiz + 1
          End If
      
          prz.MoveNext
          If prz.EOF Then Exit Do
      Loop
      If qtde_atualiz >= tota_atualiz Then loops = "F"
      If loops = "F" Then Exit Do
 Loop
  rot.MoveNext
  If rot.EOF Then Exit Do
Loop
'aqui

Return


finaliza2:

   sql = "set isolation to dirty read "
   If (ope.State) <> adStateClosed Then ope.Close
      
   telacorr = DoEvents
   ope.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents

   sql = "select *, rowid reg_log  " _
       & "  from ethos_edi_opeprazo    " _
       & "  where cod_empresa      =  '" & selemp & "' " _
       & "    and trim(den_operac) = 'TIPAGEM' " _
       & "    and prazo_operacao   is null " _
       & "   order by 1,2,3,4,5,6,10,12 "
   
   telacorr = DoEvents
   ope.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents
   
   Do While Not ope.EOF
      
      exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", AGUARDE, GRAVANDO DATA DA OPERAÇÃO TIPAGEM ... " & ope.Fields("reg_log"))
      sql = "set isolation to dirty read "
      If (rot.State) <> adStateClosed Then rot.Close
      
      telacorr = DoEvents
      rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
      telacorr = DoEvents
      
      sql = "select *                         " _
          & "  from ethos_edi_opeprazo            " _
          & " where cod_empresa            = '" & ope.Fields("cod_empresa") & "' " _
          & "   and trim(cod_item_princ)   = '" & Trim(ope.Fields("cod_item_princ")) & "' " _
          & "   and num_pedido             =  " & ope.Fields("num_pedido") & " " _
          & "   and num_seq_pedido         =  " & ope.Fields("num_seq_pedido") & " " _
          & "   and dat_entrega_princ      = '" & ope.Fields("dat_entrega_princ") & "' " _
          & "   and num_ordem              =  " & ope.Fields("num_ordem") & " " _
          & "   and num_ordem_filho        =  " & ope.Fields("num_ordem_filho") & " " _
          & "   and trim(cod_item)         = '" & Trim(ope.Fields("cod_item")) & "' " _
          & "   and trim(cod_componente)   = '" & Trim(ope.Fields("cod_componente")) & "' " _
          & "   and trim(nivel_componente) = '" & Trim(ope.Fields("nivel_componente")) & "' " _
          & "   and num_seq_operac         = " & ope.Fields("num_seq_operac") + 1
          
      telacorr = DoEvents
      rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
      telacorr = DoEvents
      
      If Not rot.EOF And Not (IsNull(rot.Fields("prazo_operacao"))) Then
         sql = "update ethos_edi_opeprazo " _
             & "   set prazo_operacao = '" & rot.Fields("prazo_operacao") & "' " _
             & "  where rowid         = " & ope.Fields("reg_log")
         
         If (tmp.State) <> adStateClosed Then tmp.Close
      
         telacorr = DoEvents
         tmp.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
         telacorr = DoEvents
      Else
         sql = "set isolation to dirty read "
         If (rot.State) <> adStateClosed Then rot.Close
      
         telacorr = DoEvents
         rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
         telacorr = DoEvents
      
         sql = "select *                         " _
             & "  from ethos_edi_opeprazo            " _
             & " where cod_empresa            = '" & ope.Fields("cod_empresa") & "' " _
             & "   and trim(cod_item_princ)   = '" & Trim(ope.Fields("cod_item_princ")) & "' " _
             & "   and num_pedido             =  " & ope.Fields("num_pedido") & " " _
             & "   and num_seq_pedido         =  " & ope.Fields("num_seq_pedido") & " " _
             & "   and dat_entrega_princ      = '" & ope.Fields("dat_entrega_princ") & "' " _
             & "   and num_ordem              =  " & ope.Fields("num_ordem") & " " _
             & "   and num_ordem_filho        =  " & ope.Fields("num_ordem_filho") & " " _
             & "   and trim(cod_item)         = '" & Trim(ope.Fields("cod_item")) & "' " _
             & "   and trim(cod_componente)   = '" & Trim(ope.Fields("cod_componente")) & "' " _
             & "   and trim(nivel_componente) = '" & Trim(ope.Fields("nivel_componente")) & "' " _
             & "   and num_seq_operac         = " & ope.Fields("num_seq_operac") - 1
          
         telacorr = DoEvents
         rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
         telacorr = DoEvents
         
         If Not rot.EOF And Not (IsNull(rot.Fields("prazo_operacao"))) Then
            sql = "update ethos_edi_opeprazo " _
                & "   set prazo_operacao = '" & rot.Fields("prazo_operacao") & "' " _
                & "  where rowid         = " & ope.Fields("reg_log")
         
            If (tmp.State) <> adStateClosed Then tmp.Close
      
            telacorr = DoEvents
            tmp.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
            telacorr = DoEvents
         End If
      End If
      ope.MoveNext
      If ope.EOF Then Exit Do
   Loop
Return

finaliza2_0:

   sql = "set isolation to dirty read "
   If (ope.State) <> adStateClosed Then ope.Close
      
   telacorr = DoEvents
   ope.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents

   sql = "select *, rowid reg_log  " _
       & "  from ethos_edi_opeprazo    " _
       & "  where cod_empresa    =  '" & selemp & "' " _
       & "    and dias_execucao  = 0 " _
       & "    and cod_operac    <> 'XXXXX' " _
       & "    and prazo_operacao is null " _
       & "   order by 1,2,3,4,5,6,10,12 "
   
   telacorr = DoEvents
   ope.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   telacorr = DoEvents
   
   Do While Not ope.EOF
      
      exibbar = SysCmd(acSysCmdSetStatus, "  PEDIDO: " & vnum_pedido & ", ITEM: " & vseq_pedido & ", AGUARDE, GRAVANDO DATA DA OPERAÇÃO NAS OPERAÇÕES COM QTDE DE DIAS DE EXECUÇÃO IGUAL A ZERO ... " & ope.Fields("reg_log"))
      
      sql = "set isolation to dirty read "
      If (rot.State) <> adStateClosed Then rot.Close
      
      telacorr = DoEvents
      rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
      telacorr = DoEvents
      
      sql = "select *                         " _
          & "  from ethos_edi_opeprazo            " _
          & " where cod_empresa            = '" & ope.Fields("cod_empresa") & "' " _
          & "   and trim(cod_item_princ)   = '" & Trim(ope.Fields("cod_item_princ")) & "' " _
          & "   and num_pedido             =  " & ope.Fields("num_pedido") & " " _
          & "   and num_seq_pedido         =  " & ope.Fields("num_seq_pedido") & " " _
          & "   and dat_entrega_princ      = '" & ope.Fields("dat_entrega_princ") & "' " _
          & "   and num_ordem              =  " & ope.Fields("num_ordem") & " " _
          & "   and num_ordem_filho        =  " & ope.Fields("num_ordem_filho") & " " _
          & "   and trim(cod_item)         = '" & Trim(ope.Fields("cod_item")) & "' " _
          & "   and trim(cod_componente)   = '" & Trim(ope.Fields("cod_componente")) & "' " _
          & "   and trim(nivel_componente) = '" & Trim(ope.Fields("nivel_componente")) & "' " _
          & "   and num_seq_operac         = " & ope.Fields("num_seq_operac") - 1
          
      telacorr = DoEvents
      rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
      telacorr = DoEvents
      
      If Not rot.EOF And Not (IsNull(rot.Fields("prazo_operacao"))) Then
         sql = "update ethos_edi_opeprazo " _
             & "   set prazo_operacao = '" & rot.Fields("prazo_operacao") & "' " _
             & "  where rowid         = " & ope.Fields("reg_log")
         
         If (tmp.State) <> adStateClosed Then tmp.Close
      
         telacorr = DoEvents
         tmp.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
         telacorr = DoEvents
      Else
         sql = "set isolation to dirty read "
         If (rot.State) <> adStateClosed Then rot.Close
      
         telacorr = DoEvents
         rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
         telacorr = DoEvents
      
         sql = "select *                         " _
             & "  from ethos_edi_opeprazo            " _
             & " where cod_empresa            = '" & ope.Fields("cod_empresa") & "' " _
             & "   and trim(cod_item_princ)   = '" & Trim(ope.Fields("cod_item_princ")) & "' " _
             & "   and num_pedido             =  " & ope.Fields("num_pedido") & " " _
             & "   and num_seq_pedido         =  " & ope.Fields("num_seq_pedido") & " " _
             & "   and dat_entrega_princ      = '" & ope.Fields("dat_entrega_princ") & "' " _
             & "   and num_ordem              =  " & ope.Fields("num_ordem") & " " _
             & "   and num_ordem_filho        =  " & ope.Fields("num_ordem_filho") & " " _
             & "   and trim(cod_item)         = '" & Trim(ope.Fields("cod_item")) & "' " _
             & "   and trim(cod_componente)   = '" & Trim(ope.Fields("cod_componente")) & "' " _
             & "   and trim(nivel_componente) = '" & Trim(ope.Fields("nivel_componente")) & "' " _
             & "   and num_seq_operac         = " & ope.Fields("num_seq_operac") + 1
          
         telacorr = DoEvents
         rot.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
         telacorr = DoEvents
         
         If Not rot.EOF And Not (IsNull(rot.Fields("prazo_operacao"))) Then
            sql = "update ethos_edi_opeprazo " _
                & "   set prazo_operacao = '" & rot.Fields("prazo_operacao") & "' " _
                & "  where rowid         = " & ope.Fields("reg_log")
         
            If (tmp.State) <> adStateClosed Then tmp.Close
      
            telacorr = DoEvents
            tmp.Open sql, connOnLine, adOpenDynamic, adLockPessimistic
            telacorr = DoEvents
         End If
      End If
      ope.MoveNext
      If ope.EOF Then Exit Do
   Loop
Return



valida_dias_naoutil:
'      MsgBox "data a validar se é útil: " & dta_encontrada
      nao_e_util = "N"
      Call encontra_nro_semana
       
      sql = "select *                   " _
          & "  from semana_sup          " _
          & " where cod_empresa = '" & selemp & "' " _
          & "   and ies_dia_semana = " & nro_semana
   
      If (bdt.State) <> adStateClosed Then bdt.Close
 
      bdt.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   
      If Not bdt.EOF Then
         If Not (IsNull(bdt.Fields("ies_situa"))) Then
            If bdt.Fields("ies_situa") = "3" Then
               dias_somar_naoutil = dias_somar_naoutil + 1
               nao_e_util = "S"
            End If
         End If
      End If
      If nao_e_util = "N" Then
          sql = "select *                  " _
          & "  from ethosm_fer_prz         " _
          & " where cod_empresa = '" & selemp & "' " _
          & "   and dat_ref = '" & Format(dta_encontrada, "dd/mm/yyyy") & "' "
           
          If (bdt.State) <> adStateClosed Then bdt.Close
  
         bdt.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
                  
         If Not bdt.EOF Then
            dias_somar_naoutil = dias_somar_naoutil + 1
         End If
      End If
Return


mens_erro:
    men_erro = Err.Description
    
    If men_erro Like "*duplicate*" Then
       MsgBox "FALHA AO GRAVAR UM REGISTRO DUPLICADO NA TABELA 'ethos_edi_opeprazo'!!", vbOKOnly, "ATENÇÃO"
       Resume fim_erro
    End If
       
    If Err.Number = -2147217887 Then
       MsgBox "PROBLEMAS AO ACESSAR O BANCO DE DADOS DO LOGIX", vbOKOnly, "ATENÇÃO"
       Resume fim_erro
    End If
       
    MsgBox "(CODIGO DO ERRO): " & Err.Number & "    (DESCRIÇÃO DO ERRO): " & Err.Description
    Resume fim_erro
  
End Sub

Sub validar_data_util()
     DoCmd.Hourglass True
     exibbar = SysCmd(acSysCmdSetStatus, "  AGUARDE, VERIFICANDO PRIMEIRO DIA ÚTIL BASE...")
     cam_arqs = Trim(CurrentDbDir)
     Set connOnLine = New ADODB.Connection
     connOnLine.Open "File Name=" & cam_arqs & "conexao.udl"
     Set lei = New ADODB.Recordset
     
     data_enc = CVDate(data_base)
     
     o_dia_e_util = "N"
         
     GoSub validar_dia_logix
       
     exibbar = SysCmd(acSysCmdSetStatus, "  ")
     If (lei.State) <> adStateClosed Then lei.Close
     Set lei = Nothing
     Set connOnLine = Nothing
     DoCmd.Hourglass False
Exit Sub

validar_dia_logix:
      o_dia_e_util = "S"
      
      GoSub achar_dia_da_semana
       
      sql = "set isolation to dirty read "
      If (lei.State) <> adStateClosed Then lei.Close
      
      telacorr = DoEvents
      lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
      telacorr = DoEvents
      
      sql = "select *                   " _
          & "  from semana_sup          " _
          & " where cod_empresa = '" & selemp & "' " _
          & "   and ies_dia_semana = " & cod_semana
 
      lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
   
      If Not lei.EOF Then
         If Not (IsNull(lei.Fields("ies_situa"))) Then
            If lei.Fields("ies_situa") = "3" Then o_dia_e_util = "N"
         End If
      End If
      
      
      If o_dia_e_util = "S" Then
      
         sql = "set isolation to dirty read "
         If (lei.State) <> adStateClosed Then lei.Close
      
         telacorr = DoEvents
         lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
         telacorr = DoEvents
         
         sql = "select *                  " _
             & "  from ethosm_fer_prz     " _
             & " where cod_empresa = '" & selemp & "' " _
             & "   and dat_ref = '" & Format(data_enc, "dd/mm/yyyy") & "' "
  
         lei.Open sql, connOnLine, ADODB.CursorTypeEnum.adOpenDynamic, ADODB.adLockReadOnly
                  
         If Not lei.EOF Then o_dia_e_util = "N"
      End If
Return

achar_dia_da_semana:
    dia_semana = StrConv(Format(data_enc, "dddd"), 1)
    If dia_semana = "DOMINGO" Then cod_semana = 0
    If dia_semana = "SEGUNDA-FEIRA" Then cod_semana = 1
    If dia_semana = "TERÇA-FEIRA" Then cod_semana = 2
    If dia_semana = "QUARTA-FEIRA" Then cod_semana = 3
    If dia_semana = "QUINTA-FEIRA" Then cod_semana = 4
    If dia_semana = "SEXTA-FEIRA" Then cod_semana = 5
    If dia_semana = "SÁBADO" Then cod_semana = 6
Return
End Sub

