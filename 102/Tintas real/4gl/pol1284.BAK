#-------------------------------------------------------------------#
# SISTEMA.: LOGIX                                                   #
# PROGRAMA: pol1280                                                 #
# OBJETIVO: RECALCULO DO JURO DE TITULOS A RECEBER                  #
# AUTOR...: IVO                                                     #
# DATA....: 25/02/15                                                #
#-------------------------------------------------------------------#

DATABASE logix

GLOBALS
    DEFINE p_cod_empresa   LIKE empresa.cod_empresa,
           p_user          LIKE usuarios.cod_usuario,
           p_status        SMALLINT,
           p_den_empresa   VARCHAR(36),
           p_versao        CHAR(18)
END GLOBALS

DEFINE m_pedido            INTEGER

MAIN
   CALL log0180_conecta_usuario()
   
   LET p_versao = 'pol1284-11.00.00' 

   WHENEVER ANY ERROR CONTINUE
      SET ISOLATION TO DIRTY READ
      SET LOCK MODE TO WAIT 300 
   DEFER INTERRUPT

        
   LET p_cod_empresa= '01'
   LET p_user       = 'admlog'     
   LET p_status = 0

   IF NUM_ARGS() > 0  THEN
      LET m_pedido = ARG_VAL(1)
      CALL pol1284_controle()
   END IF  
   
END MAIN

#--------------------------#
 FUNCTION pol1284_controle()
#--------------------------#
   
   DEFINE l_dat_atu DATETIME
   
   LET l_dat_atu = CURRENT
   
   SELECT num_pedido
     FROM consiste_ped5029
    WHERE cod_empresa = p_cod_empresa
      AND num_pedido = m_pedido
   
   IF STATUS = 100 THEN
      INSERT INTO consiste_ped5029 VALUES (
       p_cod_empresa, m_pedido, l_dat_atu, 'N')
   ELSE
      UPDATE consiste_ped5029
         SET data_consist = l_dat_atu,
             ies_processado = 'N'
       WHERE cod_empresa = p_cod_empresa
         AND num_pedido = m_pedido
   END IF
   
   CALL pol1284_consiste()

   UPDATE consiste_ped5029
      SET ies_processado = 'S'
    WHERE cod_empresa = p_cod_empresa
      AND num_pedido = m_pedido
     
END FUNCTION

#--------------------------#
FUNCTION pol1284_consiste()
#--------------------------#
   
   DEFINE l_status    SMALLINT, 
          l_commit    CHAR(15)
   
   CALL vdp90043_create_temp_tables(0)      # Antes de iniciar a transação
   
   CALL log085_transacao('BEGIN')
   
   CALL vdp90043_mr_param_set_usa_temp('N') # para buscar os dados já gravados na pedidos, ped_itens, etc.
   CALL vdp90043_mr_param_set_tipo_acao('C')# Consulta
   CALL vdp90043_mr_param_set_empresa(p_cod_empresa)
   CALL vdp90043_mr_param_set_pedido_ini(m_pedido)
   CALL vdp90043_mr_param_set_pedido_fim(m_pedido)
 
   CALL vdp90043_consiste_gera_pedido(1) RETURNING l_status, l_commit

   IF l_commit THEN
      CALL log085_transacao('COMMIT')
   ELSE
      CALL log085_transacao('ROLLBACK')
   END IF

END FUNCTION
